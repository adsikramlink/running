<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Efektivitas Running — Input & History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body{font-family:'Inter',sans-serif;background:#f1f5f9;color:#0f1724}
    .card{background:white;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);padding:18px}
    .fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:999px;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(2,6,23,0.12)}
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="bg-slate-900 text-white py-4 px-6 sticky top-0 z-40">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div>
        <h1 class="text-lg font-bold">Efektivitas Running</h1>
        <div class="text-slate-400 text-xs">Dashboard v3.0 Final</div>
      </div>
      <div class="flex items-center gap-3">
        <a id="btnAddData" href="admin.html" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-2 rounded text-sm font-bold">+ Tambah Data</a>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 space-y-6">

    <!-- SUMMARY / PREVIEW (opsional) -->
    <section class="card">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="font-bold text-lg">Ringkasan</h2>
          <p class="text-sm text-slate-500">Preview status terakhir dan history pembuatan form.</p>
        </div>
        <div class="text-sm text-slate-500"> <span id="lastUpdated">—</span> </div>
      </div>
      <div class="mt-4 grid grid-cols-3 gap-3">
        <div class="p-3 bg-slate-50 rounded">
          <div class="text-xs text-slate-400">Total SDT</div>
          <div id="stat-sdt" class="font-black text-indigo-700 text-xl">0</div>
        </div>
        <div class="p-3 bg-slate-50 rounded">
          <div class="text-xs text-slate-400">Total Units</div>
          <div id="stat-units" class="font-black text-indigo-700 text-xl">0</div>
        </div>
        <div class="p-3 bg-slate-50 rounded">
          <div class="text-xs text-slate-400">History</div>
          <div id="stat-history" class="font-black text-indigo-700 text-xl">0</div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h3 class="font-bold">History Pembuatan Form</h3>
        <button onclick="clearHistoryView()" class="text-sm text-slate-500">Refresh</button>
      </div>
      <div id="historyList" class="mt-3 space-y-2 text-sm text-slate-700">
        <!-- history items akan render di sini -->
        <div class="text-slate-400 italic">Memuat history...</div>
      </div>
    </section>

    <!-- UNIT BUTTONS (dari settings.lists) -->
    <section class="card">
      <h3 class="font-bold mb-2">Unit (klik untuk langsung input SDT)</h3>
      <div id="unitButtons" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- FORM SECTION -->
    <section id="formSection" class="card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold">Isi Form SDT (Publik)</h3>
        <div class="text-xs text-slate-400">Siapa saja bisa mengisi</div>
      </div>

      <form id="sdtForm" class="space-y-3" onsubmit="event.preventDefault(); submitForm();">
        <div class="grid grid-cols-12 gap-2">
          <div class="col-span-4">
            <label class="text-xs text-slate-500">Unit</label>
            <select id="formUnit" class="w-full p-2 border rounded bg-white"></select>
          </div>
          <div class="col-span-4">
            <label class="text-xs text-slate-500">Driver</label>
            <select id="formDriver" class="w-full p-2 border rounded bg-white"></select>
          </div>
          <div class="col-span-2">
            <label class="text-xs text-slate-500">Trip</label>
            <input id="formTrip" type="number" min="0" class="w-full p-2 border rounded bg-white" value="0">
          </div>
          <div class="col-span-2">
            <label class="text-xs text-slate-500">SD</label>
            <select id="formSd" class="w-full p-2 border rounded bg-white">
              <option>SD1</option><option>SD2</option><option>SD3</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-xs text-slate-500">Keterangan (opsional)</label>
          <input id="formKet" class="w-full p-2 border rounded bg-white" placeholder="Contoh: Breakdown / Extra Trip">
        </div>

        <div class="flex gap-2">
          <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Kirim</button>
          <button type="button" onclick="resetForm()" class="bg-slate-100 px-4 py-2 rounded">Reset</button>
        </div>

        <div id="formMsg" class="text-sm text-slate-500"></div>
      </form>
    </section>

  </main>

  <!-- Floating button (isi form cepat) -->
  <button class="fab bg-indigo-600 text-white" title="Isi Form" onclick="scrollToForm()">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
  </button>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
  // --------- Firebase config (pakai milikmu) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDGPkoewPcjffZ8ORwB3rrVAKiYtRYzuEk",
    authDomain: "retase-20ec2.firebaseapp.com",
    projectId: "retase-20ec2",
    storageBucket: "retase-20ec2.firebasestorage.app",
    messagingSenderId: "414104675676",
    appId: "1:414104675676:web:95f0012dadfb1743ff8d99"
  };

  // state
  let db, masterUnits = [], masterDrivers = [], historyData = [], sdtCount = 0;

  // Safe init: tunggu SDK ter-load
  (function waitForFirebase(){
    let tries=0;
    const id=setInterval(()=>{
      tries++;
      if(window.firebase && firebase.firestore){
        clearInterval(id);
        try {
          if(!firebase.apps || firebase.apps.length===0) firebase.initializeApp(firebaseConfig);
          db = firebase.firestore();
          startApp();
        } catch(e){
          console.error(e); alert('Gagal inisialisasi Firebase: '+e.message);
        }
      } else if(tries>60){
        clearInterval(id);
        alert('Firebase SDK gagal dimuat. Buka di Chrome / periksa koneksi.');
      }
    },200);
  })();

  function startApp(){
    subscribeLists();
    subscribeSdt();
    subscribeHistory();
  }

  // subscribe settings/lists
  function subscribeLists(){
    db.doc('settings/lists').onSnapshot(doc=>{
      if(!doc.exists){ renderUnits([],[]); return; }
      const d = doc.data()||{};
      masterUnits = d.masterUnits || [];
      masterDrivers = d.masterDrivers || [];
      renderUnits(masterUnits, masterDrivers);
    }, err => { console.error('lists listen', err); renderUnits([],[]); });
  }

  function renderUnits(units, drivers){
    const uEl = document.getElementById('unitButtons'), selUnit=document.getElementById('formUnit'), selDriver=document.getElementById('formDriver');
    uEl.innerHTML = units.map(u=>`<button class="px-3 py-1 bg-slate-100 rounded text-sm" onclick="quickAdd('${escapeHtml(u)}')">${u}</button>`).join(' ');
    selUnit.innerHTML = units.map(u=>`<option value="${escapeHtml(u)}">${u}</option>`).join('') || '<option value="">-</option>';
    selDriver.innerHTML = `<option value="">Driver...</option>` + drivers.map(d=>`<option value="${escapeHtml(d)}">${d}</option>`).join('');
    document.getElementById('stat-units').innerText = (units||[]).length;
  }

  // subscribe sdt collection
  function subscribeSdt(){
    db.collection('sdt').onSnapshot(snap=>{
      sdtCount = snap.size;
      document.getElementById('stat-sdt').innerText = sdtCount;
    }, err => console.error('sdt listen', err));
  }

  // subscribe history (latest 50)
  function subscribeHistory(){
    db.collection('history').orderBy('ts','desc').limit(50).onSnapshot(snap=>{
      historyData = [];
      snap.forEach(d => historyData.push({ id:d.id, ...d.data() }));
      renderHistory();
      document.getElementById('stat-history').innerText = historyData.length;
      if(historyData.length>0){
        const t = historyData[0].ts && historyData[0].ts.toDate ? historyData[0].ts.toDate() : new Date();
        document.getElementById('lastUpdated').innerText = t.toLocaleString();
      }
    }, err => {
      console.error('history listen', err);
      document.getElementById('historyList').innerHTML = '<div class="text-red-500">Gagal memuat history.</div>';
    });
  }

  function renderHistory(){
    const el = document.getElementById('historyList');
    if(!historyData || historyData.length===0){
      el.innerHTML = '<div class="text-slate-400 italic">Belum ada history.</div>';
      return;
    }
    el.innerHTML = historyData.map(h => {
      const t = h.ts && h.ts.toDate ? h.ts.toDate().toLocaleString() : '';
      const by = h.by || 'public';
      const action = h.action || JSON.stringify(h).slice(0,80);
      return `<div class="border-b pb-2 pt-2">
        <div class="text-xs text-slate-400">${t} — <strong>${escapeHtml(by)}</strong></div>
        <div class="text-sm">${escapeHtml(action)}</div>
      </div>`;
    }).join('');
  }

  // QUick add from unit button: open form prefilled & scroll
  function quickAdd(unit){
    document.getElementById('formUnit').value = unit;
    scrollToForm();
  }

  // form submit: create sdt doc & history
  function submitForm(){
    const unit = document.getElementById('formUnit').value || '';
    const driver = document.getElementById('formDriver').value || '';
    const trip = parseInt(document.getElementById('formTrip').value) || 0;
    const sd = document.getElementById('formSd').value || '';
    const ket = document.getElementById('formKet').value || '';

    if(!unit){ showFormMsg('Pilih unit terlebih dahulu','red'); return; }

    const doc = { unit, driver, trip, sd, ket, createdAt: firebase.firestore.FieldValue.serverTimestamp() };

    db.collection('sdt').add(doc)
      .then(ref => {
        // history entry
        db.collection('history').add({ action: `create SDT ${unit} ${trip} Trip`, by:'public', ts: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
        showFormMsg('Berhasil dikirim', 'green');
        document.getElementById('sdtForm').reset();
      })
      .catch(err => {
        console.error('submitForm', err);
        showFormMsg('Gagal: ' + err.message, 'red');
      });
  }

  function showFormMsg(txt, color='slate'){
    const el = document.getElementById('formMsg');
    el.innerText = txt;
    el.style.color = (color==='green'?'#059669':(color==='red'?'#DC2626':'#64748b'));
    setTimeout(()=>{ el.innerText=''; }, 4000);
  }

  function resetForm(){
    document.getElementById('sdtForm').reset();
  }

  function scrollToForm(){
    document.getElementById('formSection').scrollIntoView({behavior:'smooth', block:'center'});
  }

  function clearHistoryView(){ subscribeHistory(); }

  // small helper to escape
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

</script>
</body>
</html>