<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mining App v28 (Cloud Master)</title>
    <style>
        /* --- CSS MODERN UI (v18 Base) --- */
        :root { --primary: #4f46e5; --bg: #f8fafc; --text: #1e293b; --border: #e2e8f0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }

        /* LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; font-weight: bold; backdrop-filter: blur(5px); }
        .spinner { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LAYOUT */
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background: var(--bg); display: none; padding-bottom: 120px; }
        .page.active { display: block; }
        .navbar { background: #0f172a; color: white; padding: 16px; position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        
        /* KOMPONEN UI */
        .card { background: white; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 16px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { background: #f1f5f9; padding: 10px 16px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 12px; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; display:flex; justify-content:space-between; align-items:center; }
        .card-body { padding: 16px; }
        
        label { display: block; font-size: 10px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
        .input-std { width: 100%; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; font-size: 14px; font-weight: 600; }
        .input-under { width: 100%; border: none; border-bottom: 2px solid #e2e8f0; padding: 6px 0; font-size: 14px; background: transparent; transition: 0.2s; }
        .input-under:focus { border-color: var(--primary); }

        .chip-label { position: relative; display: inline-block; margin: 0 4px 4px 0; }
        .chip-label input { position: absolute; opacity: 0; width: 100%; height: 100%; z-index: 10; cursor: pointer; }
        .chip-div { padding: 5px 12px; border-radius: 20px; border: 1px solid #cbd5e1; background: #fff; color: #64748b; font-size: 11px; font-weight: 700; transition: 0.2s; position: relative; z-index: 1; }
        .chip-label input:checked + .chip-div { background-color: var(--primary); color: white; border-color: var(--primary); }

        /* SDT ROW - 1 BARIS RAPI */
        .sdt-row { display: flex; align-items: center; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 4px 8px; margin-bottom: 6px; gap: 8px; height: 42px; }
        .sdt-unit { font-size: 11px; font-weight: 800; color: var(--primary); background: #e0e7ff; padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
        .sdt-select { flex: 2; border: none; background: transparent; font-size: 12px; font-weight: 600; width: 100%; }
        .sdt-trip { width: 50px; border: none; background: #f1f5f9; text-align: center; font-size: 12px; font-weight: 700; padding: 6px 2px; border-radius: 4px; }
        .sdt-ket { flex: 1; border: none; background: transparent; font-size: 11px; color: #ef4444; font-style: italic; min-width: 0; text-align:right; }
        .sdt-del { border: none; background: transparent; color: #cbd5e1; font-size: 16px; font-weight: bold; padding: 0 4px; }

        .grid-time { display: grid; grid-template-columns: 20px 1fr 1fr 20px; gap: 6px; align-items: center; margin-bottom: 6px; }
        .time-box { display: flex; align-items: center; border: 1px solid #cbd5e1; border-radius: 6px; overflow: hidden; background: white; }
        .time-inp { width: 50%; border: none; text-align: center; font-weight: 700; font-size: 13px; padding: 6px 0; }

        .pt-row { background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
        .pt-head { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; font-size: 12px; font-weight: 800; color: #334155; }
        .pt-grid { display: grid; grid-template-columns: 20px 1fr 1fr 30px; gap: 6px; align-items: center; margin-bottom: 4px; font-size: 11px; }
        .pt-inp { width: 100%; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; font-weight: 600; }
        .pt-dot { width: 8px; height: 8px; border-radius: 50%; }
        .bg-0 { background: orange; } .bg-1 { background: green; } .bg-2 { background: #eab308; }

        .row { display: flex; gap: 10px; } .col { flex: 1; }
        .fab { position: fixed; bottom: 24px; right: 24px; background: var(--primary); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 15px rgba(30, 64, 175, 0.4); border: none; z-index: 100; }
        .btn-act { width: 100%; padding: 10px; border-radius: 8px; font-weight: 700; font-size: 12px; border: none; margin-top: 8px; cursor: pointer; transition: 0.2s; }
        .btn-act:active { transform: scale(0.95); opacity: 0.8; }
        .btn-blue { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
        
        .tabs { display: flex; background: #f1f5f9; padding: 3px; border-radius: 6px; gap: 3px; margin-bottom: 10px; }
        .tab { flex: 1; padding: 6px; text-align: center; font-size: 11px; font-weight: 700; color: #64748b; border-radius: 4px; border: none; background: transparent; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .hist-item { background: white; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        /* SETTINGS UI */
        .master-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 12px; font-weight: 600; }
        .sync-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 11px; color: #166534; display: flex; justify-content: space-between; align-items: center; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loader" class="hidden"><div class="spinner"></div><div id="load-text">Memproses...</div></div>

    <div id="page-home" class="page active">
        <div class="navbar">
            <div><div style="font-weight:700">Mining Dashboard</div><div style="font-size:10px; opacity:0.7; color:#bfdbfe;">v28.0 (Sync)</div></div>
            <button onclick="nav('settings')" style="background:none; border:none; font-size:20px;">‚öôÔ∏è</button>
        </div>
        <div class="container">
            <div id="sync-bar" class="sync-box">
                <span id="sync-msg">Memuat Data Master...</span>
                <button onclick="syncMaster()" style="background:white; border:1px solid #166534; color:#166534; padding:2px 8px; border-radius:4px; font-weight:bold;">üîÑ Refresh</button>
            </div>
            <div id="history-list"></div>
            <div id="empty-msg" style="text-align:center; margin-top:50px; color:#cbd5e1;"><div style="font-size:40px; margin-bottom:10px">üìÇ</div><div>Belum ada laporan</div></div>
        </div>
        <button onclick="openForm()" class="fab">+</button>
    </div>

    <div id="page-form" class="page">
        <div class="navbar">
            <button onclick="nav('home')" style="background:none; border:none; color:white; font-weight:600">‚Üê Tutup</button>
            <div style="font-weight:700">Input Data</div>
            <button onclick="uploadReport()" style="background:#22c55e; border:none; color:white; padding:6px 12px; border-radius:6px; font-weight:700; font-size:11px">KIRIM</button>
        </div>
        <div class="container">
            <div class="card"><div class="card-header">0. Operasional</div><div class="card-body">
                <div class="row"><div class="col"><label>Shift</label><select id="inpShift" class="input-std"><option value="NIGHT SHIFT">üåô NIGHT SHIFT</option><option value="DAY SHIFT">‚òÄÔ∏è DAY SHIFT</option></select></div><div class="col"><label>Tanggal</label><input type="date" id="inpDate" class="input-std"></div></div>
                <div style="margin-top:12px"><label>SUPERVISOR</label><div id="box-spv" class="chip-container"></div><input id="inpSpvM" placeholder="+ Manual (Ketik Nama)" class="input-under"></div>
                <div style="margin-top:12px"><label>FOREMAN</label><div id="box-frm" class="chip-container"></div><input id="inpFrmM" placeholder="+ Manual" class="input-under"></div>
                <div style="margin-top:12px"><label>CHECKER</label><div id="box-chk" class="chip-container"></div><input id="inpChkM" placeholder="+ Manual" class="input-under"></div>
                <div class="row" style="margin-top:16px"><div class="col" style="background:#eff6ff; padding:10px; border-radius:8px; border:1px solid #bfdbfe"><label style="color:#2563eb">TIPPING ROM</label><input type="number" id="inpTip" placeholder="0" class="input-under" style="font-size:20px; font-weight:900; color:#1e3a8a"></div><div class="col" style="background:#ecfdf5; padding:10px; border-radius:8px; border:1px solid #a7f3d0"><label style="color:#059669">TRANSFER ROM</label><input type="number" id="inpTrans" placeholder="0" class="input-under" style="font-size:20px; font-weight:900; color:#064e3b"></div></div>
            </div></div>
            <div class="card"><div class="card-header">1. Durasi Conveyor</div><div class="card-body">
                <div id="conv-tabs" class="tabs"></div><div class="grid-time" style="opacity:0.5; font-size:9px; font-weight:bold; text-align:center;"><div>#</div><div>MULAI</div><div>SELESAI</div><div>DEL</div></div><div id="conv-contents"></div>
                <button onclick="addTimeRow()" class="btn-act btn-blue" style="border-style:dashed">+ Tambah Jam</button>
                <div class="row" style="margin-top:16px; padding-top:10px; border-top:1px solid #f1f5f9; text-align:center;"><div class="col"><div style="font-size:9px; color:#94a3b8; font-weight:bold">TOTAL JAM</div><div id="res-val" style="font-size:16px; font-weight:900; color:#334155">-</div></div><div class="col"><div style="font-size:9px; color:#94a3b8; font-weight:bold">EFEKTIVITAS</div><div id="eff-val" style="font-size:12px; font-weight:bold; color:#334155">-</div></div></div>
            </div></div>
            <div class="card"><div class="card-header">2. Perhitungan Unit & Trip</div><div class="card-body"><div id="hauling-rows"></div><div style="background:#f1f5f9; padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-top:12px;"><span style="font-weight:bold; color:#64748b; font-size:11px">TOTAL HAULING</span><span id="grand-total" style="font-weight:900; color:var(--primary); font-size:20px;">0</span></div></div></div>
            <div class="card"><div class="card-header"><span>3. Unit SDT Running</span><button onclick="nav('settings')" style="font-size:10px; color:var(--primary); background:none; border:none; font-weight:bold">+ MASTER</button></div><div class="card-body">
                <label>PILIH UNIT:</label><div id="box-unit-btns" style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:12px;"></div><div id="sdt-list"></div><div id="sdt-empty" style="text-align:center; padding:20px; color:#cbd5e1; font-style:italic; border:1px dashed #e2e8f0; border-radius:8px; font-size:11px;">Belum ada unit dipilih</div>
            </div></div>
            <div class="row" style="margin-bottom:40px;"><button onclick="copyReport(false)" class="btn-act" style="background:white; border:1px solid #d8b4fe; color:#7e22ce;">Salin SIANG</button><button onclick="copyReport(true)" class="btn-act" style="background:white; border:1px solid #c7d2fe; color:#4338ca;">Salin MALAM</button></div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div class="navbar"><button onclick="nav('home')" style="background:none; border:none; color:white;">‚Üê Kembali</button><span>Data Master (Online)</span><div style="width:20px"></div></div>
        <div class="container">
            <div class="card"><div class="card-header">Personil</div><div class="card-body">
                <div class="master-group"><label>SUPERVISOR</label><div id="list-m-spv"></div><div class="row" style="margin-top:5px"><input id="new-spv" class="input-std" placeholder="Nama Baru"><button onclick="addCloudMaster('spv')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
                <div class="master-group"><label>FOREMAN</label><div id="list-m-frm"></div><div class="row" style="margin-top:5px"><input id="new-frm" class="input-std" placeholder="Nama Baru"><button onclick="addCloudMaster('frm')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
                <div class="master-group"><label>CHECKER</label><div id="list-m-chk"></div><div class="row" style="margin-top:5px"><input id="new-chk" class="input-std" placeholder="Nama Baru"><button onclick="addCloudMaster('chk')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
            </div></div>
            <div class="card"><div class="card-header">Operasional</div><div class="card-body">
                <div class="master-group"><label>CONVEYOR</label><div id="list-m-conv"></div><div class="row" style="margin-top:5px"><input id="new-conv" class="input-std" placeholder="Cth: SD4"><button onclick="addCloudMaster('conv')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
                <div class="master-group"><label>PT / KONTRAKTOR</label><div id="list-m-pt"></div><div class="row" style="margin-top:5px"><input id="new-pt" class="input-std" placeholder="Cth: PPA"><button onclick="addCloudMaster('pt')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
            </div></div>
            <div class="card"><div class="card-header">Unit & Driver</div><div class="card-body">
                <div class="master-group"><label>UNIT SDT</label><div id="list-m-unit"></div><div class="row" style="margin-top:5px"><input id="new-unit" class="input-std" placeholder="No Unit"><button onclick="addCloudMaster('unit')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
                <div class="master-group"><label>DRIVER</label><div id="list-m-driver"></div><div class="row" style="margin-top:5px"><input id="new-driver" class="input-std" placeholder="Nama Driver"><button onclick="addCloudMaster('driver')" class="input-std" style="width:40px;background:#f1f5f9;">+</button></div></div>
            </div></div>
        </div>
    </div>

    <script>
        // ===============================================
        //  ISI DENGAN URL DEPLOYMENT TERBARU ANDA:
        // ===============================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkh64voq37OXXBbh0ITbdhL0zLouD7p_0n8Hja2uuzEz-NI6erqNs4X-6OxC_PVQBR8A/exec";
        // ===============================================

        // Default Data (Jika offline/pertama kali)
        const DEF = {
            spv: ['Ihsan R'], frm: ['Gunawan TC'], chk: ['Indra R'],
            conv: ['SD1', 'SD2', 'SD3'], pt: ['MHA', 'KARUNIA', 'BUMA'],
            unit: ['01-F'], driver: ['Jeksen']
        };

        let masters = {...DEF};
        let activeConv='', convData={}, sdtData=[], currentId=null;

        window.onload = () => {
            document.getElementById('inpDate').valueAsDate = new Date();
            const cached = localStorage.getItem('master_cache');
            if(cached) masters = JSON.parse(cached);
            
            loadHistoryList();
            renderFormUI();
            syncMaster(); // Auto Sync saat buka
        };

        function nav(p) { document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); document.getElementById(`page-${p}`).classList.add('active'); if(p==='settings')renderSettings(); if(p==='home')loadHistoryList(); }
        function openForm(id=null) { currentId=id; nav('form'); renderFormUI(); if(id)loadFormData(id); else resetForm(); }
        function showLoader(t) { document.getElementById('loader').classList.remove('hidden'); document.getElementById('load-text').innerText=t; }
        function hideLoader() { document.getElementById('loader').classList.add('hidden'); }

        // --- CLOUD FUNCTIONS ---
        function syncMaster() {
            const inf = document.getElementById('sync-msg');
            inf.innerText = "Menyinkronkan data...";
            inf.style.color = "orange";

            fetch(GOOGLE_SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                ['spv','frm','chk','conv','pt','unit','driver'].forEach(k => {
                    if(data[k] && data[k].length > 0) masters[k] = data[k];
                    else if(!masters[k]) masters[k] = DEF[k];
                });
                localStorage.setItem('master_cache', JSON.stringify(masters));
                renderFormUI(); renderSettings();
                inf.innerText = "Data Master Terbaru ‚úîÔ∏è"; inf.style.color = "green";
            })
            .catch(e => {
                inf.innerText = "Gagal Sync (Mode Offline)"; inf.style.color = "red";
            });
        }

        function addCloudMaster(k) {
            const input = document.getElementById(`new-${k}`);
            const val = input.value.toUpperCase().trim();
            if(!val) return;
            if(!masters[k].includes(val)) masters[k].push(val); // Optimistic
            renderSettings();
            input.value = '';
            
            showLoader("Menyimpan Master...");
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: {"Content-Type": "text/plain"},
                body: JSON.stringify({ action: "tambah_master", jenis: k, nama: val })
            }).then(() => hideLoader());
        }

        function delCloudMaster(k, idx) {
            if(!confirm("Hapus permanen dari Cloud?")) return;
            const val = masters[k][idx];
            masters[k].splice(idx, 1); // Optimistic
            renderSettings();
            
            showLoader("Menghapus...");
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: {"Content-Type": "text/plain"},
                body: JSON.stringify({ action: "hapus_master", jenis: k, nama: val })
            }).then(() => hideLoader());
        }

        function uploadReport() {
            const data = ambilDataForm();
            data.action = "simpan_laporan";
            simpanKeLS(data); 
            showLoader("Mengirim Laporan...");

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(data)
            })
            .then(() => { hideLoader(); alert("Laporan Terkirim & Tersimpan!"); nav('home'); })
            .catch(e => { hideLoader(); alert("Gagal kirim ke server (Disimpan di HP)"); });
        }

        // --- UI RENDERERS ---
        function renderFormUI() {
            const renC = (id,l) => document.getElementById(id).innerHTML=l.map(t=>`<label class="chip-label"><input type="checkbox" value="${t}" class="hidden"><div class="chip-div">${t}</div></label>`).join('');
            renC('box-spv',masters.spv); renC('box-frm',masters.frm); renC('box-chk',masters.chk);
            if(!masters.conv || masters.conv.length===0) masters.conv=['SD1'];
            document.getElementById('conv-tabs').innerHTML=masters.conv.map(c=>`<button onclick="switchConv('${c}')" id="tab-${c}" class="tab">${c}</button>`).join('');
            document.getElementById('conv-contents').innerHTML=masters.conv.map(c=>`<div id="cont-${c}" class="hidden"></div>`).join('');
            masters.conv.forEach(c=>{ if(!convData[c])convData[c]=[]; }); if(masters.conv.length>0) switchConv(masters.conv[0]);
            document.getElementById('hauling-rows').innerHTML=masters.pt.map((pt,i)=>`<div class="pt-row"><div class="pt-head"><span class="pt-dot bg-${i%3}"></span><span>${pt}</span></div><div class="pt-grid" style="color:#94a3b8; text-align:center;"><div></div><div>UNIT</div><div>TRIP</div><div>HSL</div></div><div class="pt-grid"><div>‚òÄÔ∏è</div><input type="number" id="run-s-${pt}" class="pt-inp" placeholder="0" oninput="calcHauling('${pt}')"><input type="number" id="trip-s-${pt}" class="pt-inp" placeholder="0" oninput="calcHauling('${pt}')"><div id="res-s-${pt}" style="font-weight:900;text-align:center">0</div></div><div class="pt-grid"><div>üåô</div><input type="number" id="run-m-${pt}" class="pt-inp" placeholder="0" oninput="calcHauling('${pt}')"><input type="number" id="trip-m-${pt}" class="pt-inp" placeholder="0" oninput="calcHauling('${pt}')"><div id="res-m-${pt}" style="font-weight:900;text-align:center">0</div></div></div>`).join('');
            document.getElementById('box-unit-btns').innerHTML=masters.unit.map(u=>`<button onclick="addSdt('${u}')" style="background:#eff6ff;border:1px solid #bfdbfe;font-size:10px;padding:4px 8px;border-radius:4px;font-weight:bold;color:#2563eb;cursor:pointer;">${u}</button>`).join('');
        }

        function renderSettings() {
            const r=(k,a)=>document.getElementById(`list-m-${k}`).innerHTML=a.map((x,i)=>`<div class="master-item"><span>${x}</span><button onclick="delCloudMaster('${k}',${i})" class="btn-del">Hapus</button></div>`).join('');
            r('spv',masters.spv); r('frm',masters.frm); r('chk',masters.chk); r('conv',masters.conv); r('pt',masters.pt); r('unit',masters.unit); r('driver',masters.driver);
        }

        // --- LOGIC ---
        function switchConv(n) { activeConv=n; masters.conv.forEach(c=>{document.getElementById(`tab-${c}`).classList.remove('active');document.getElementById(`cont-${c}`).classList.add('hidden');}); document.getElementById(`tab-${n}`).classList.add('active'); document.getElementById(`cont-${n}`).classList.remove('hidden'); calcConv(); }
        function addTimeRow(n=activeConv) { if(!convData[n])convData[n]=[]; convData[n].push({sh:'',sm:'',fh:'',fm:''}); renderConvRows(n); }
        function renderConvRows(n) { document.getElementById(`cont-${n}`).innerHTML=convData[n].map((d,i)=>`<div class="grid-time"><div style="text-align:center;font-size:10px;color:#cbd5e1;">${i+1}</div><div class="time-box"><input type="tel" value="${d.sh}" class="time-inp" oninput="updT('${n}',${i},'sh',this)"><span style="font-weight:bold;color:#cbd5e1">:</span><input type="tel" value="${d.sm}" class="time-inp" oninput="updT('${n}',${i},'sm',this)"></div><div class="time-box"><input type="tel" value="${d.fh}" class="time-inp" oninput="updT('${n}',${i},'fh',this)"><span style="font-weight:bold;color:#cbd5e1">:</span><input type="tel" value="${d.fm}" class="time-inp" oninput="updT('${n}',${i},'fm',this)"></div><button onclick="delT('${n}',${i})" style="color:#ef4444;background:none;border:none;font-weight:bold;">‚úï</button></div>`).join(''); calcConv(); }
        function updT(n,i,f,el) { let v=el.value.replace(/\D/g,'');if(v.length>2)v=v.slice(0,2);convData[n][i][f]=v; calcConv(); }
        function delT(n,i) { convData[n].splice(i,1); renderConvRows(n); }
        function calcConv() { let t=0; (convData[activeConv]||[]).forEach(d=>{if(d.sh&&d.sm&&d.fh&&d.fm){let s=parseInt(d.sh)*60+parseInt(d.sm),f=parseInt(d.fh)*60+parseInt(d.fm);if(f<s)f+=1440;t+=(f-s);}}); const h=Math.floor(t/60),m=t%60; document.getElementById('res-val').innerText=`${h}j ${m}m`; let r=(12*60)-t, rh=Math.floor(Math.abs(r)/60), rm=Math.abs(r)%60; const el=document.getElementById('eff-val'); if(t===0){el.innerText='-';el.style.color="#cbd5e1";}else if(r>=0){el.innerText=`${rh}j ${rm}m`;el.style.color="#059669";}else{el.innerText=`${rh}j ${rm}m (Over)`;el.style.color="#ef4444";} }
        function calcHauling(pt) { const v=(id)=>parseFloat(document.getElementById(id).value)||0; const rs=v(`run-s-${pt}`),ts=v(`trip-s-${pt}`),rm=v(`run-m-${pt}`),tm=v(`trip-m-${pt}`); document.getElementById(`res-s-${pt}`).innerText=ts-rs; document.getElementById(`res-m-${pt}`).innerText=(tm-ts)-rm; let t=0; masters.pt.forEach(p=>t+=(v(`trip-m-${p}`)-v(`trip-s-${p}`))); document.getElementById('grand-total').innerText=t+" Trip"; }
        
        function addSdt(u) { sdtData.push({unit:u,driver:'',trip:'',ket:''}); renderSdt(); }
        function renderSdt() { 
            const c=document.getElementById('sdt-list'); 
            if(sdtData.length===0){c.innerHTML='';document.getElementById('sdt-empty').style.display='block';return;} 
            document.getElementById('sdt-empty').style.display='none'; 
            const o=`<option value="">Supir...</option>`+masters.driver.map(d=>`<option value="${d}">${d}</option>`).join(''); 
            c.innerHTML=sdtData.map((d,i)=>`
                <div class="sdt-row">
                    <div class="sdt-unit">${d.unit}</div>
                    <select onchange="sdtData[${i}].driver=this.value" class="sdt-select">${o.replace(`value="${d.driver}"`,`value="${d.driver}" selected`)}</select>
                    <input type="number" placeholder="Trp" value="${d.trip}" oninput="sdtData[${i}].trip=this.value" class="sdt-trip">
                    <input placeholder="Ket..." value="${d.ket}" oninput="sdtData[${i}].ket=this.value" class="sdt-ket">
                    <button onclick="sdtData.splice(${i},1);renderSdt();" class="sdt-del">√ó</button>
                </div>
            `).join(''); 
        }

        function ambilDataForm() {
            // FIX NAMA: Retrieve text from sibling div
            const getC = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e => e.nextElementSibling.innerText);
            const val = (id) => document.getElementById(id).value;
            let ptD={}, tTrip=0; 
            let convSum=[], haulDet=[], sdtDet=[];

            masters.pt.forEach(p=>{ 
                ptD[p]={rs:val(`run-s-${p}`),ts:val(`trip-s-${p}`),rm:val(`run-m-${p}`),tm:val(`trip-m-${p}`)}; 
                let diff = (val('inpShift') === 'NIGHT SHIFT') ? (val(`trip-m-${p}`) - val(`trip-s-${p}`)) : val(`trip-s-${p}`);
                tTrip+=diff;
                haulDet.push(`${p}=${diff}`);
            });

            masters.conv.forEach(sd => {
                let t=0; (convData[sd]||[]).forEach(d=>{if(d.sh&&d.sm&&d.fh&&d.fm){let s=parseInt(d.sh)*60+parseInt(d.sm),f=parseInt(d.fh)*60+parseInt(d.fm);if(f<s)f+=1440;t+=(f-s);}});
                convSum.push(`${sd}: ${Math.floor(t/60)}j ${t%60}m`);
            });
            sdtDet = sdtData.map(s => `${s.unit}(${s.driver}):${s.trip}`).join(', ');

            return { 
                id:currentId||Date.now(), date:val('inpDate'), shift:val('inpShift'), 
                spv:getC('box-spv').join(', ') + (val('inpSpvM') ? ', '+val('inpSpvM'):''), 
                frm:getC('box-frm').join(', ') + (val('inpFrmM') ? ', '+val('inpFrmM'):''), 
                chk:getC('box-chk').join(', ') + (val('inpChkM') ? ', '+val('inpChkM'):''), 
                rom_tip:val('inpTip'), rom_trans:val('inpTrans'), 
                total_haul:tTrip,
                detail_haul: haulDet.join(', '),
                detail_conv: convSum.join(', '),
                detail_sdt: sdtDet,
                conv:convData, pt:ptD, sdt:sdtData 
            };
        }

        function simpanKeLS(d) { let h=JSON.parse(localStorage.getItem('m_v28')||'[]'); const i=h.findIndex(x=>x.id===d.id); if(i>-1)h[i]=d; else {h.unshift(d); currentId=d.id;} localStorage.setItem('m_v28',JSON.stringify(h)); }
        function loadHistoryList() { const h=JSON.parse(localStorage.getItem('m_v28')||'[]'); document.getElementById('history-list').innerHTML=h.map(d=>`<div class="hist-item" onclick="openForm(${d.id})"><div><div style="font-weight:700">${d.date||'Tanpa Tanggal'}</div><div style="font-size:11px; color:#64748b; margin-top:2px;">${d.shift} | ${d.total_haul||0} Trip</div></div><button onclick="delHist(event,${d.id})" style="color:#ef4444; border:none; background:none; font-weight:bold; font-size:16px;">üóëÔ∏è</button></div>`).join(''); document.getElementById('empty-msg').style.display=h.length?'none':'block'; }
        function delHist(e,id) { e.stopPropagation(); if(confirm('Hapus?')){ let h=JSON.parse(localStorage.getItem('m_v28')||'[]'); h=h.filter(x=>x.id!==id); localStorage.setItem('m_v28',JSON.stringify(h)); loadHistoryList(); } }
        
        function loadFormData(id) { 
            const d=JSON.parse(localStorage.getItem('m_v28')).find(x=>x.id===id); if(!d)return; resetForm(); 
            document.getElementById('inpDate').value=d.date; document.getElementById('inpShift').value=d.shift;
            
            const checkC = (bid, str) => { if(str) { const arr=str.split(', '); document.querySelectorAll(`#${bid} input`).forEach(i=>{ if(arr.includes(i.nextElementSibling.innerText)) i.checked=true; }); } };
            checkC('box-spv', d.spv); checkC('box-frm', d.frm); checkC('box-chk', d.chk);

            document.getElementById('inpTip').value=d.rom_tip; document.getElementById('inpTrans').value=d.rom_trans; 
            convData = d.conv || {}; renderConvRows(masters.conv[0]);
            masters.pt.forEach(p=>{ if(d.pt && d.pt[p]){ document.getElementById(`run-s-${p}`).value=d.pt[p].rs; document.getElementById(`trip-s-${p}`).value=d.pt[p].ts; document.getElementById(`run-m-${p}`).value=d.pt[p].rm; document.getElementById(`trip-m-${p}`).value=d.pt[p].tm; calcHauling(p); }}); 
            sdtData=d.sdt; renderSdt();
        }
        
        function resetForm() { 
            document.querySelectorAll('input').forEach(i=>i.value=''); 
            document.querySelectorAll('input[type=checkbox]').forEach(i=>i.checked=false); 
            document.getElementById('inpDate').valueAsDate = new Date(); 
            convData={}; masters.conv.forEach(c=>{convData[c]=[];addTimeRow(c);addTimeRow(c);addTimeRow(c);addTimeRow(c);}); renderConvRows(masters.conv[0]); 
            sdtData=[]; renderSdt(); 
            masters.pt.forEach(p=>{const s=document.getElementById(`res-s-${p}`),m=document.getElementById(`res-m-${p}`);if(s)s.innerText='0';if(m)m.innerText='0';}); 
            document.getElementById('grand-total').innerText="0"; 
        }

        function copyReport(isMalam) {
            const d = ambilDataForm(); simpanKeLS(d); 
            
            // Trigger Upload
            data.action = "simpan_laporan";
            uploadReport(); 

            const fmtDate = (ds) => { if(!ds) return '-'; const dt = new Date(ds); const m = ["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGU","SEP","OKT","NOV","DES"]; return `${dt.getDate()}/${m[dt.getMonth()]}/${dt.getFullYear().toString().substr(-2)}`; };
            const cleanStr = (s) => s.replace(/(^, )|(, $)/g, ''); 

            let txt=`*CHP OPERATION*\n*${d.shift}*\n*${fmtDate(d.date)}*\n\n*Supervisor* : ${cleanStr(d.spv)}\n*Foreman* : ${cleanStr(d.frm)}\n*Checker* : ${cleanStr(d.chk)}\n\n*Efektivitas RUNNING*\n`;
            masters.conv.forEach(sd=>{let t=0;(d.conv[sd]||[]).forEach(i=>{if(i.sh){let s=parseInt(i.sh)*60+parseInt(i.sm),f=parseInt(i.fh)*60+parseInt(i.fm);if(f<s)f+=1440;t+=(f-s);}});const h=Math.floor(t/60),m=t%60;if(t===0)txt+=`- ${sd} = -\n`;else txt+=`- ${sd} = ${h} Jam ${m} Menit\n`;});
            
            txt+=`\n*HAULING*\n`; let tH=0; 
            const vn=(id)=>parseFloat(document.getElementById(id).value)||0;
            masters.pt.forEach(p=>{
                const ts=vn(`trip-s-${p}`), tm=vn(`trip-m-${p}`);
                const r=isMalam?(tm-ts):ts; tH+=r; 
                txt+=`- ${p.padEnd(5)} = ${r>0?r+' TRIP':'- TRIP'}\n`;
            });
            
            txt+=`\n*UNIT 2 TRIP*\n`; masters.pt.forEach(p=>{
                const rs=vn(`run-s-${p}`), ts=vn(`trip-s-${p}`), rm=vn(`run-m-${p}`), tm=vn(`trip-m-${p}`);
                const u=isMalam?(tm-ts)-rm:ts-rs; 
                txt+=`- ${p.padEnd(5)} = ${u!=0?u+' Unit':'- Unit'}\n`;
            });
            
            txt+=`\n*TRIP SDT TRANSFER*\n`; if(d.sdt.length===0)txt+=`-\n`;else d.sdt.forEach(x=>txt+=`- ${x.unit} (${x.driver||'-'}) : ${x.trip||'-'} Trip ${x.ket?`*${x.ket}*`:''}\n`);
            
            const tp=vn('inpTip'), tr=vn('inpTrans'), ta=tr+tH;
            txt+=`\n\n*TOTAL HAULING   = ${tH>0?tH+' Trip':'- Trip'}*\n*TIPPING ROM        = ${tp>0?tp+' Trip':'- Trip'}*\n*TRANSFER ROM   = ${tr>0?tr+' Trip':'- Trip'}*\n*TRANSFER ROM + HAULING = ${ta>0?ta+' Trip':'- Trip'}*\n`;
            
            const el=document.createElement('textarea');el.value=txt;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);alert("Disalin!");
        }
    </script>
</body>
</html>
