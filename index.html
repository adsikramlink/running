<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <title>Efektivitas Running</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color:#f1f5f9; color:#1e293b; }
        .page { display:none; } .page.active { display:block; }
        .input-base { width:100%; padding:8px; background:white; border:1px solid #cbd5e1; border-radius:6px; font-weight:600; }
        .input-base:focus { border-color:#4f46e5; box-shadow:0 0 0 2px rgba(79,70,229,.15); }
        .chip-label input:checked + div { background:#4f46e5; color:white; border-color:#4f46e5; }
        .chip-div { padding:4px 10px; border-radius:99px; border:1px solid #cbd5e1; background:white; font-size:11px; font-weight:700; color:#64748b; cursor:pointer; }
        .hidden { display:none !important; }
    </style>

    <!-- Firebase INIT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGPkoewPcjffZ8ORwB3rrVAKiYtRYzuEk",
            authDomain: "retase-20ec2.firebaseapp.com",
            projectId: "retase-20ec2",
            storageBucket: "retase-20ec2.firebasestorage.app",
            messagingSenderId: "414104675676",
            appId: "1:414104675676:web:95f0012dadfb1743ff8d99",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window._db = db;
        window._doc = doc;
        window._set = setDoc;
        window._get = getDoc;
        window._add = addDoc;
        window._del = deleteDoc;
        window._listen = onSnapshot;
        window._col = collection;
    </script>
</head>
<body class="pb-32">
<!-- HOME -->
<div id="page-home" class="page active">
    <div class="bg-slate-900 text-white py-4 px-4 flex justify-between sticky top-0 z-50">
        <div>
            <h1 class="text-lg font-bold">Efektivitas Running</h1>
            <p class="text-[10px] text-slate-400">Dashboard</p>
        </div>
        <button onclick="nav('admin')" class="p-2">
            <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="max-w-3xl mx-auto px-4 mt-6">
        <div id="history-list"></div>
        <div id="empty-history" class="text-center text-slate-400 mt-20">
            <div style="font-size:40px">ðŸ“‚</div>Belum ada riwayat
        </div>
    </div>

    <button onclick="nav('form')" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-blue-600 text-white text-3xl shadow-lg flex items-center justify-center">+</button>
</div>

<!-- ADMIN -->
<div id="page-admin" class="page">
    <div class="bg-slate-900 text-white py-4 px-4 flex justify-between sticky top-0 z-50">
        <button onclick="nav('home')"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <h1 class="font-bold text-lg">Admin Panel</h1>
        <div class="w-5"></div>
    </div>

    <div class="max-w-3xl mx-auto px-4 mt-6 space-y-6 pb-24">

        <!-- loop 5 section -->
        <div id="admin-sections"></div>

        <button onclick="saveMaster()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold shadow">
            Simpan ke Server
        </button>
    </div>
</div>

<!-- FORM -->
<div id="page-form" class="page">
    <div class="bg-slate-900 text-white py-4 px-4 flex justify-between sticky top-0 z-50">
        <button onclick="nav('home')"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
        <h1 class="font-bold text-lg">Input Form</h1>
        <div class="w-5"></div>
    </div>

    <!-- FORM ISI -->
    <div class="max-w-3xl mx-auto px-4 mt-6 space-y-6 pb-24">

        <section class="bg-white rounded-xl border shadow p-4">
            <h2 class="font-bold text-slate-700 mb-4 text-sm">0. Operasional</h2>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400">Shift</label>
                    <select id="shift" class="input-base">
                        <option>NIGHT SHIFT</option>
                        <option>DAY SHIFT</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400">Tanggal</label>
                    <input type="date" id="tanggal" class="input-base">
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-400">Supervisor</label>
                <div id="chip-spv" class="flex flex-wrap gap-2 mt-1"></div>
                <input id="manual-spv" placeholder="+ Manual" class="border-b w-full mt-1">
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-400">Foreman</label>
                <div id="chip-frm" class="flex flex-wrap gap-2 mt-1"></div>
                <input id="manual-frm" placeholder="+ Manual" class="border-b w-full mt-1">
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-400">Checker</label>
                <div id="chip-chk" class="flex flex-wrap gap-2 mt-1"></div>
                <input id="manual-chk" placeholder="+ Manual" class="border-b w-full mt-1">
            </div>

        </section>

        <button onclick="saveForm()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow">
            Simpan & Masuk History
        </button>

    </div>
</div>
<script>
/* ============================
   NAVIGATION
============================ */
function nav(page){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-'+page).classList.add('active');
    lucide.createIcons();
}

/* ============================
   MASTER DATA
============================ */
let ms = {
    spv: [], frm: [], chk: [], unit: [], driver: []
};

async function loadMaster(){
    const snap = await _get(_doc(_db,"settings","lists"));
    if(snap.exists()){
        let d = snap.data();
        ms.spv = d.spv || [];
        ms.frm = d.frm || [];
        ms.chk = d.chk || [];
        ms.unit = d.unit || [];
        ms.driver = d.driver || [];
    }
    renderAdmin();
    renderChips();
}

function renderAdmin(){
    const sec = [
        ["Supervisor","spv"],
        ["Foreman","frm"],
        ["Checker","chk"],
        ["Unit SDT","unit"],
        ["Driver SDT","driver"],
    ];

    let html = "";
    sec.forEach(([label,key])=>{
        html += `
        <section class="bg-white rounded-xl shadow border p-4">
            <h2 class="font-bold text-slate-700 text-sm mb-2">${label}</h2>
            <div id="list-${key}" class="text-xs mb-2"></div>
            <div class="flex gap-2">
                <input id="inp-${key}" placeholder="Tambah ${label}" class="input-base">
                <button onclick="addMaster('${key}')" class="bg-indigo-600 text-white px-3 rounded">+</button>
            </div>
        </section>`;
    });

    document.getElementById("admin-sections").innerHTML = html;
    renderAdminList();
}

function renderAdminList(){
    ["spv","frm","chk","unit","driver"].forEach(k=>{
        document.getElementById('list-'+k).innerHTML =
            ms[k].map((v,i)=>`
                <div class="flex justify-between items-center">
                    <span>- ${v}</span>
                    <button onclick="delMaster('${k}',${i})" class="text-red-500 text-xs">Hapus</button>
                </div>
            `).join('');
    });
}

function addMaster(key){
    const el = document.getElementById("inp-"+key);
    let v = el.value.trim();
    if(!v) return;
    ms[key].push(v);
    el.value = "";
    renderAdminList();
    renderChips();
}

function delMaster(key,i){
    ms[key].splice(i,1);
    renderAdminList();
    renderChips();
}

async function saveMaster(){
    await _set(
        _doc(_db,"settings","lists"),
        { ...ms, _adminKey:"mpadmin" },
        { merge:true }
    );
    alert("Master berhasil disimpan!");
}

/* ============================
   FORM â€” Render Chips
============================ */
function renderChips(){
    makeChip("chip-spv", ms.spv);
    makeChip("chip-frm", ms.frm);
    makeChip("chip-chk", ms.chk);
}

function makeChip(id, arr){
    document.getElementById(id).innerHTML =
        arr.map(v=>`
            <label class="chip-label">
                <input type="checkbox" value="${v}" class="hidden">
                <div class="chip-div">${v}</div>
            </label>
        `).join('');
}

function getChecked(id){
    return [...document.querySelectorAll(`#${id} input:checked`)]
        .map(e=>e.value);
}

/* ============================
   FORM â€” SAVE
============================ */
async function saveForm(){
    const record = {
        date: document.getElementById("tanggal").value,
        shift: document.getElementById("shift").value,
        spv: [...getChecked("chip-spv"), document.getElementById("manual-spv").value].filter(Boolean),
        frm: [...getChecked("chip-frm"), document.getElementById("manual-frm").value].filter(Boolean),
        chk: [...getChecked("chip-chk"), document.getElementById("manual-chk").value].filter(Boolean),
        time: Date.now()
    };

    await _add(_col(_db,"history"), record);
    alert("Data berhasil disimpan!");
    nav("home");
}

/* ============================
   HISTORY REALTIME + DELETE
============================ */
function loadHistory(){
    _listen(_col(_db,"history"), snap=>{
        let html = "";
        let count = 0;

        snap.forEach(doc=>{
            count++;
            let d = doc.data();
            html += `
                <div class="bg-white p-3 rounded-lg shadow mb-2 border border-slate-200 flex justify-between">
                    <div>
                        <div class="font-bold">${d.date}</div>
                        <div class="text-xs text-slate-500">${d.shift}</div>
                    </div>

                    <button onclick="deleteHistory('${doc.id}')"
                        class="text-red-500 text-xs">Hapus</button>
                </div>
            `;
        });

        document.getElementById("history-list").innerHTML = html;
        document.getElementById("empty-history").style.display = count ? "none":"block";
        lucide.createIcons();
    });
}

async function deleteHistory(id){
    if(!confirm("Hapus riwayat ini?")) return;
    await _del(_doc(_db,"history",id));
}

/* ============================
   INIT
============================ */
window.onload = async ()=>{
    await loadMaster();
    loadHistory();
    lucide.createIcons();
};
</script>

</body>
</html>