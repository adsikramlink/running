<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Efektivitas Running - Single File (Pages: Home/Form/Admin)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  body { font-family:'Inter',sans-serif; background:#f1f5f9; color:#0f172a; margin:0; padding-bottom:120px; }
  .navbar { background:#0f172a; color:white; padding:14px; position:sticky; top:0; z-index:60; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 6px rgba(0,0,0,0.08); }
  .btn { padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
  .btn-primary { background:#4f46e5;color:white;border:none; }
  .btn-ghost { background:white;border:1px solid #e6eefb;color:#0f172a; }
  .container { max-width:980px; margin:18px auto; padding:0 16px; }
  .card { background:white;border-radius:12px;box-shadow:0 1px 3px rgba(2,6,23,0.08); padding:14px; margin-bottom:14px; }
  .muted { color:#64748b; font-size:13px; }
  .fab { position:fixed; right:20px; bottom:20px; width:56px; height:56px; border-radius:50%; background:#2563eb; color:white; display:flex; align-items:center; justify-content:center; font-size:26px; z-index:80; box-shadow:0 6px 18px rgba(37,99,235,0.25); border:none; cursor:pointer; }
  .hidden { display:none !important; }
  .small { font-size:13px; color:#475569; }
  input, select, textarea { font-weight:600; padding:8px 10px; border-radius:6px; border:1px solid #e6eefb; width:100%; }
  .chips { display:flex; flex-wrap:wrap; gap:8px; }
  .chip { padding:6px 10px; border-radius:999px; border:1px solid #e6eefb; background:white; cursor:pointer; font-weight:700; font-size:13px; color:#475569; }
  .chip.active { background:#4f46e5;color:white;border-color:#4f46e5; }
  .page { display:none; }
  .page.active{ display:block; }
  .admin-panel { display:flex; gap:10px; align-items:center; }
  .history-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:8px; border:1px solid #eef2ff; background:white; margin-bottom:8px; }
  .back-link { cursor:pointer; color:#0ea5a3; font-weight:700; }
  .toast { position:fixed; left:50%; transform:translateX(-50%); top:90px; background:#111827; color:white; padding:8px 12px; border-radius:8px; display:none; z-index:200; }
  .admin-form { display:flex; gap:8px; margin-top:10px; align-items:center; }
  .admin-list { margin-top:10px; font-size:13px; color:#334155; }
  .error-note { color:#ef4444; font-weight:700; }
</style>
</head>
<body>

  <div class="navbar">
    <div><strong>Efektivitas Running</strong><div class="muted">Dashboard v3.0 Final</div></div>
    <div style="display:flex; gap:10px; align-items:center;">
      <div id="navHome" class="btn btn-ghost" onclick="nav('home')">Beranda</div>
      <div id="navForm" class="btn btn-ghost" onclick="nav('form')">Isi Form</div>
      <div id="navAdmin" class="btn btn-ghost" onclick="nav('admin')">Admin</div>
    </div>
  </div>

  <div class="container">

    <!-- Home page: history -->
    <div id="page-home" class="page active">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong>Riwayat Terakhir</strong><div class="muted small">Riwayat pembuatan form</div></div>
          <div id="histCount" class="muted small">0</div>
        </div>
        <div id="historyList" style="margin-top:12px;">
          <div class="muted">Memuat history...</div>
        </div>
      </div>

      <!-- Admin summary kecil (tombol buka admin) -->
      <div class="card" id="adminSummary">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong>Admin</strong><div class="muted small">Tambah data master (supervisor, foreman, checker, unit, driver)</div></div>
          <div><button class="btn btn-primary" onclick="nav('admin')">Buka Admin</button></div>
        </div>
      </div>
    </div>

    <!-- Form page: isi form (sembunyikan home & admin saat aktif) -->
    <div id="page-form" class="page">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:12px; align-items:center;">
          <div class="back-link" onclick="nav('home')">← Kembali</div>
          <div><strong>Input Data</strong><div class="muted small">Isi laporan harian</div></div>
        </div>
        <div><button class="btn btn-primary" onclick="submitForm()">KIRIM (Salin)</button></div>
      </div>

      <!-- Form body: saya ambil struktur kamu (ringkas tapi fungsional) -->
      <div id="formBody">
        <!-- 0. Data Operasional -->
        <div class="card">
          <div><strong>0. Data Operasional</strong></div>
          <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <div>
              <label class="small">Shift</label>
              <select id="f_shift"><option>NIGHT SHIFT</option><option>DAY SHIFT</option></select>
            </div>
            <div>
              <label class="small">Tanggal</label>
              <input id="f_date" type="date">
            </div>
          </div>

          <div style="margin-top:10px;">
            <label class="small">Supervisor</label>
            <div id="f_spv" class="chips"></div>
            <input id="f_spv_manual" placeholder="+ Manual" />
          </div>

          <div style="margin-top:10px;">
            <label class="small">Foreman</label>
            <div id="f_frm" class="chips"></div>
            <input id="f_frm_manual" placeholder="+ Manual" />
          </div>

          <div style="margin-top:10px;">
            <label class="small">Checker</label>
            <div id="f_chk" class="chips"></div>
            <input id="f_chk_manual" placeholder="+ Manual" />
          </div>
        </div>

        <!-- (Saya tidak tulis ulang semua field conveyor & sdt; kode JS akan mengisi/menangani seperti sebelumnya) -->
        <div id="formDynamic" class="card">
          <div><strong>1. (Form detail)</strong></div>
          <div class="muted small">Form lengkap di file JS (mirip script asli).</div>
        </div>

      </div>
    </div>

    <!-- Admin page: tambah data master -->
    <div id="page-admin" class="page">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:12px; align-items:center;">
          <div class="back-link" onclick="nav('home')">← Kembali</div>
          <div><strong>Admin - Tambah Data Master</strong><div class="muted small">Hanya untuk menambah daftar master</div></div>
        </div>
        <div><span id="adminStatus" class="muted small"></span></div>
      </div>

      <div class="card">
        <div style="display:flex; gap:12px; align-items:center;">
          <select id="adminType" style="width:200px;">
            <option value="supervisor">Supervisor</option>
            <option value="foreman">Foreman</option>
            <option value="checker">Checker</option>
            <option value="unit">Unit</option>
            <option value="driver">Driver</option>
          </select>
          <input id="adminValue" placeholder="Masukkan nama / kode (mis. 01-F / Agus)" />
          <button class="btn btn-primary" onclick="adminAdd()">Tambah</button>
          <button class="btn btn-ghost" onclick="adminRefresh()">Refresh</button>
        </div>

        <div class="admin-list" id="adminLists">
          <div><strong>Supervisor:</strong> <span id="listSpv">-</span></div>
          <div><strong>Foreman:</strong> <span id="listFrm">-</span></div>
          <div><strong>Checker:</strong> <span id="listChk">-</span></div>
          <div><strong>Unit:</strong> <span id="listUnit">-</span></div>
          <div><strong>Driver:</strong> <span id="listDriver">-</span></div>
        </div>
      </div>
    </div>

  </div>

  <!-- FAB (tambah form) tetap -->
  <button class="fab" id="fab">+</button>

  <div id="toast" class="toast"></div>

  <!-- Firebase compat dynamic loader (will try then fallback) -->
  <script>
  // ====== CONFIG & DEFAULTS ======
  const DEFAULTS = {
    spv: ['Ihsan R','Dicky F','Sopian'],
    frm: ['Gunawan TC','Hardiansyah','Lewi S','Elimelek J','Andry K','Yulius R'],
    chk: ['Indra R','Jemmie P','Ikram','Fahri T','Indra A','Andhy S','Agus','Angga','Henderi A','L Fauzan N','Nanda P'],
    units: ["01-F","02-F","03-F","3A-F","05-F","08-P","09-P","10-P","25-P"],
    drivers: ["Jeksen","Saipul","Julio","Ardianur","Suryadi","Agung","Faturahman"]
  };

  const firebaseConfig = {
    apiKey: "AIzaSyDGPkoewPcjffZ8ORwB3rrVAKiYtRYzuEk",
    authDomain: "retase-20ec2.firebaseapp.com",
    projectId: "retase-20ec2",
    storageBucket: "retase-20ec2.firebasestorage.app",
    messagingSenderId: "414104675676",
    appId: "1:414104675676:web:95f0012dadfb1743ff8d99",
    measurementId: "G-64RN0GNMPW"
  };

  // app state
  let db = null;
  let useFirestore = false;
  let MASTER = { spv: DEFAULTS.spv.slice(), frm: DEFAULTS.frm.slice(), chk: DEFAULTS.chk.slice(), units: DEFAULTS.units.slice(), drivers: DEFAULTS.drivers.slice() };

  // ====== NAV helper (3 pages) ======
  function nav(p){
    document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
    if(p === 'home'){ document.getElementById('page-home').classList.add('active'); }
    else if(p === 'form'){ document.getElementById('page-form').classList.add('active'); }
    else if(p === 'admin'){ document.getElementById('page-admin').classList.add('active'); }
    // update nav highlight (small)
    document.querySelectorAll('#navHome,#navForm,#navAdmin').forEach(n=>n.classList.remove('active'));
  }

  // FAB: open form (same as nav('form')), but we want to hide home/admin while form active (done by nav)
  document.getElementById('fab').onclick = ()=> nav('form');

  // ====== UI init ======
  function renderMasterUI(){
    // chips on form
    const spvWrap = document.getElementById('f_spv');
    spvWrap.innerHTML = ''; MASTER.spv.forEach(x=>{
      const btn = document.createElement('div'); btn.className='chip'; btn.innerText = x;
      btn.onclick = ()=> btn.classList.toggle('active');
      spvWrap.appendChild(btn);
    });
    const frmWrap = document.getElementById('f_frm'); frmWrap.innerHTML = ''; MASTER.frm.forEach(x=>{
      const btn=document.createElement('div'); btn.className='chip'; btn.innerText = x; btn.onclick=()=>btn.classList.toggle('active'); frmWrap.appendChild(btn);
    });
    const chkWrap = document.getElementById('f_chk'); chkWrap.innerHTML=''; MASTER.chk.forEach(x=>{ const btn=document.createElement('div'); btn.className='chip'; btn.innerText=x; btn.onclick=()=>btn.classList.toggle('active'); chkWrap.appendChild(btn); });

    // admin lists
    document.getElementById('listSpv').innerText = MASTER.spv.join(', ');
    document.getElementById('listFrm').innerText = MASTER.frm.join(', ');
    document.getElementById('listChk').innerText = MASTER.chk.join(', ');
    document.getElementById('listUnit').innerText = MASTER.units.join(', ');
    document.getElementById('listDriver').innerText = MASTER.drivers.join(', ');
  }

  // ====== ADMIN actions ======
  function adminAdd(){
    const type = document.getElementById('adminType').value;
    const val = document.getElementById('adminValue').value.trim();
    if(!val) return alert('Masukkan nilai.');
    if(type==='supervisor') MASTER.spv.push(val);
    if(type==='foreman') MASTER.frm.push(val);
    if(type==='checker') MASTER.chk.push(val);
    if(type==='unit') MASTER.units.push(val.toUpperCase());
    if(type==='driver') MASTER.drivers.push(val);
    renderMasterUI();
    document.getElementById('adminValue').value = '';
    // try save to firestore if available
    if(useFirestore && db){
      db.collection('settings').doc('lists').set(MASTER, { merge:true }).then(()=> showToast('Master tersimpan di server')).catch(e=>{ console.error(e); showToast('Gagal simpan master ke server'); });
    } else {
      // save local as fallback
      localStorage.setItem('master_local', JSON.stringify(MASTER));
      showToast('Master tersimpan lokal (offline)');
    }
  }
  function adminRefresh(){
    if(useFirestore && db){
      db.collection('settings').doc('lists').get().then(doc=>{
        if(doc.exists){ MASTER = Object.assign(MASTER, doc.data()); renderMasterUI(); showToast('Diambil dari server'); }
        else showToast('Belum ada data di server');
      }).catch(e=>{ console.error(e); showToast('Gagal memuat dari server'); });
    } else {
      const local = JSON.parse(localStorage.getItem('master_local')||'null');
      if(local){ MASTER = local; renderMasterUI(); showToast('Diambil dari storage lokal'); }
      else showToast('Tidak ada data lokal');
    }
  }

  // ====== HISTORY handling (simple local first) ======
  function loadHistoryLocal(){
    const arr = JSON.parse(localStorage.getItem('hist')||'[]');
    renderHistory(arr);
  }
  function renderHistory(arr){
    const wrap = document.getElementById('historyList');
    const cnt = document.getElementById('histCount');
    if(!arr || arr.length===0){ wrap.innerHTML = '<div class="muted">Belum ada history.</div>'; cnt.innerText='0'; return; }
    cnt.innerText = String(arr.length);
    wrap.innerHTML = arr.map(h=>`<div class="history-item"><div><strong>${h.date||'-'}</strong><div class="muted small">${h.shift||'-'} | Total: ${h.total || '-'}</div></div><div><button class="btn btn-ghost" onclick="viewSummary(${encodeURIComponent(JSON.stringify(h))})">Lihat</button></div></div>`).join('');
  }
  function viewSummary(hStr){
    // hStr is object encoded: parse and open simple window
    const h = hStr;
    const w = window.open('', '_blank');
    w.document.write('<pre style="white-space:pre-wrap;padding:12px;font-family:Arial">'+ (h.summary||JSON.stringify(h, null,2)) +'</pre>');
  }

  // ====== FORM submit (copy & save history) ======
  function submitForm(){
    // build summary minimal
    const shift = document.getElementById('f_shift').value;
    const date = document.getElementById('f_date').value || (new Date().toISOString().split('T')[0]);
    // collect selected chips
    function collect(id, manualId){
      const arr=[]; document.querySelectorAll('#'+id+' .chip.active').forEach(n=>arr.push(n.innerText));
      const m = document.getElementById(manualId).value.trim(); if(m) arr.push(m);
      return arr.join(', ');
    }
    const spv = collect('f_spv','f_spv_manual');
    const frm = collect('f_frm','f_frm_manual');
    const chk = collect('f_chk','f_chk_manual');

    const summary = `Tanggal: ${date}\nShift: ${shift}\nSupervisor: ${spv}\nForeman: ${frm}\nChecker: ${chk}\n\n(Detail form ada di halaman input)`;
    // copy to clipboard
    const ta = document.createElement('textarea'); ta.value = summary; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    showToast('Teks disalin & history disimpan.');

    // save history object
    const obj = { date, shift, spv, frm, chk, summary, total: '-', ts: Date.now() };

    if(useFirestore && db){
      db.collection('history').add(obj).then(()=> {
        // also update local list (optimistic)
        const arr = JSON.parse(localStorage.getItem('hist')||'[]'); arr.unshift(obj); localStorage.setItem('hist', JSON.stringify(arr)); loadHistoryLocal();
        nav('home'); // back to home automatically
      }).catch(e=>{
        console.error('save history err', e);
        const arr = JSON.parse(localStorage.getItem('hist')||'[]'); arr.unshift(obj); localStorage.setItem('hist', JSON.stringify(arr)); loadHistoryLocal();
        nav('home');
      });
    } else {
      const arr = JSON.parse(localStorage.getItem('hist')||'[]'); arr.unshift(obj); localStorage.setItem('hist', JSON.stringify(arr)); loadHistoryLocal(); nav('home');
    }
  }

  // ====== Toast util ======
  function showToast(txt, ms=2200){
    const t = document.getElementById('toast'); t.innerText = txt; t.style.display='block';
    setTimeout(()=> t.style.display='none', ms);
  }

  // ====== Firebase dynamic loader & fallback explanation ======
  // We'll try to load compatibility SDKs (app + firestore). If after timeout they didn't initialize,
  // we fallback to offline/local mode (useFirestore=false).
  function loadFirebaseCompat(timeoutMs=4000){
    return new Promise((resolve)=>{
      let loaded = false;
      function tryInit(){
        try{
          if(window.firebase && firebase.firestore){
            if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            useFirestore = true;
            loaded = true;
            console.info('Firebase compat loaded');
            resolve(true);
            return;
          }
        } catch(e){ console.warn('init compat err', e); }
      }
      // dynamically insert scripts
      const s1 = document.createElement('script'); s1.src='https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js'; s1.onload = tryInit; document.head.appendChild(s1);
      const s2 = document.createElement('script'); s2.src='https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js'; s2.onload = tryInit; document.head.appendChild(s2);
      // wait up to timeout
      const tmr = setTimeout(()=>{
        if(!loaded){
          console.warn('Firebase compat load timeout -> offline mode');
          useFirestore = false;
          resolve(false);
        }
      }, timeoutMs);
      // also try immediate init after short delay
      setTimeout(tryInit, 800);
    });
  }

  // ====== On page load ======
  window.addEventListener('load', async ()=>{
    // set default date
    document.getElementById('f_date').value = new Date().toISOString().split('T')[0];
    // try load firebase
    const ok = await loadFirebaseCompat(4500);
    if(!ok){
      showToast('Firebase tidak tersedia — mode offline aktif. Buka di Chrome & HTTPS (GitHub Pages) jika ingin online.', 5000);
      // try load master from local storage (fallback)
      const local = JSON.parse(localStorage.getItem('master_local')||'null');
      if(local) MASTER = local;
      else localStorage.setItem('master_local', JSON.stringify(MASTER));
      renderMasterUI();
      loadHistoryLocal();
    } else {
      // load remote settings & history
      renderMasterUI();
      // subscribe settings & history (basic)
      db.collection('settings').doc('lists').get().then(doc=>{
        if(doc.exists){ MASTER = Object.assign(MASTER, doc.data()); renderMasterUI(); }
      }).catch(e=>console.warn('load settings err', e));
      db.collection('history').orderBy('ts','desc').limit(20).get().then(snap=>{
        const arr = []; snap.forEach(d=> arr.push(d.data())); if(arr.length) { localStorage.setItem('hist', JSON.stringify(arr)); renderHistory(arr); }
        else loadHistoryLocal();
      }).catch(e=>{ console.warn('load history err', e); loadHistoryLocal(); });
    }
  });

  // initial UI render
  renderMasterUI();
  loadHistoryLocal();
  </script>

  <!-- ===== FIRESTORE RULES EXAMPLE (copy paste to Firebase Console -> Firestore -> Rules for testing) =====
  // WARNING: rule below is OPEN and insecure. Only use for quick testing.
  service cloud.firestore {
    match /databases/{database}/documents {
      match /{document=**} {
        allow read, write: if true;
      }
    }
  }
  ============================================================================= -->

  <!-- TIPS : jika SDK selalu offline
   1) Buka halaman lewat HTTPS (contoh: https://<username>.github.io/<repo>/) — jangan file://
   2) Buka DevTools console (Chrome) -> lihat error CORS / network (itu kunci penyebab)
   3) Pastikan Firestore di Firebase console sudah di-enable, dan rules sementara di-set (lihat contoh di atas)
   4) Jika masih error, kirimkan screenshot console.log (atau paste pesan) ke saya — saya bantu baca.
  -->

</body>
</html>