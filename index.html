<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Efektivitas Running - Input</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>body{font-family:Inter,system-ui,...}/* singkatkan css */</style>
</head>
<body class="pb-24">
  <div class="p-4 max-w-3xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-xl font-bold">Efektivitas Running (Input)</h1>
      <div class="flex gap-2">
        <a href="admin.html" class="bg-slate-200 px-3 py-1 rounded text-sm">Admin</a>
      </div>
    </div>

    <!-- minimal form area (pakai desainmu sebelumnya) -->
    <div id="unitButtons" class="mb-4"></div>

    <div id="sdtList" class="space-y-2"></div>
    <div id="emptyMsg" class="text-center py-8 italic text-slate-400">Belum ada data. Klik tombol unit di atas.</div>

    <div class="mt-6">
      <button onclick="refreshNow()" class="bg-indigo-600 text-white px-4 py-2 rounded">Refresh</button>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <script>
  // --- PASTE FIREBASE CONFIG DI SINI (gunakan config project-mu) ---
  const firebaseConfig = {
    apiKey: "AIzaS... (dari project)",
    authDomain: "retase-20ec2.firebaseapp.com",
    projectId: "retase-20ec2",
    storageBucket: "retase-20ec2.firebasestorage.app",
    messagingSenderId: "414104675676",
    appId: "1:414104675676:web:95f0012dadfb1743ff8d99"
  };

  // safe init (tunggu SDK)
  function initFirebaseAndStart() {
    let tries = 0;
    const max = 60;
    const t = setInterval(()=> {
      tries++;
      if(window.firebase && firebase.firestore) {
        clearInterval(t);
        if(!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        startApp();
      } else if(tries>=max) {
        clearInterval(t);
        alert('Firebase SDK gagal dimuat. Periksa koneksi atau buka di Chrome.');
      }
    }, 200);
  }
  initFirebaseAndStart();

  // application logic
  let masterUnits = ["01-F","02-F","03-F","3A-F","05-F","08-P","09-P","10-P","25-P"];
  let masterDrivers = [];
  let sdtData = [];

  function startApp() {
    subscribeLists();
    subscribeSdtList();
  }

  // subscribe settings/lists doc
  function subscribeLists() {
    db.doc('settings/lists').onSnapshot(doc => {
      if(!doc.exists) return;
      const data = doc.data();
      masterUnits = data.masterUnits || masterUnits;
      masterDrivers = data.masterDrivers || [];
      renderUnitButtons();
    }, err => console.error(err));
  }

  function renderUnitButtons() {
    const el = document.getElementById('unitButtons');
    el.innerHTML = masterUnits.map(u => `<button onclick="addSdt('${u}')" class="border px-2 py-1 mr-2 mb-2 rounded">${u}</button>`).join('');
  }

  // subscribe sdt
  function subscribeSdtList() {
    db.collection('sdt').orderBy('createdAt').onSnapshot(snap => {
      sdtData = [];
      snap.forEach(d => sdtData.push({ id:d.id, ...d.data() }));
      renderSdtList();
    }, err => console.error(err));
  }

  function renderSdtList() {
    const c = document.getElementById('sdtList');
    const m = document.getElementById('emptyMsg');
    if(sdtData.length===0) { c.innerHTML=''; m.style.display='block'; return;}
    m.style.display='none';
    c.innerHTML = sdtData.map((d,i)=> {
      const drvOpts = `<select onchange="updSdt(${i},'driver',this.value)"><option value="">-</option>` + (masterDrivers||[]).map(dd=>`<option ${dd===d.driver?'selected':''}>${dd}</option>`).join('') + '</select>';
      return `<div class="p-3 border rounded flex gap-2 items-center">
        <div class="w-24 font-bold">${d.unit}</div>
        <div>${drvOpts}</div>
        <div><input type="number" value="${d.trip||0}" onchange="updSdt(${i},'trip',this.value)" style="width:80px"></div>
        <div><input value="${d.ket||''}" onchange="updSdt(${i},'ket',this.value)"></div>
        <div><button onclick="delSdt(${i})" style="color:red">Hapus</button></div>
      </div>`;
    }).join('');
  }

  // add sdt - public (no login)
  function addSdt(unit) {
    const payload = { unit, driver:'', trip:0, ket:'', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    db.collection('sdt').add(payload).then(()=>{
      // write history
      db.collection('history').add({ action:'addSdt', unit, by:'public', ts: firebase.firestore.FieldValue.serverTimestamp()});
    }).catch(e=> { console.error(e); alert('Gagal menambah SDT'); });
  }

  function delSdt(i) {
    const id = sdtData[i]?.id; if(!id) return;
    db.collection('sdt').doc(id).delete().then(()=>{
      db.collection('history').add({ action:'delSdt', id, by:'public', ts: firebase.firestore.FieldValue.serverTimestamp()});
    }).catch(e=>{console.error(e); alert('Gagal hapus');});
  }

  function updSdt(i,f,v) {
    const id = sdtData[i]?.id; if(!id) return;
    const payload = {}; payload[f] = (f==='trip'? parseInt(v)||0 : v);
    db.collection('sdt').doc(id).set(payload, { merge:true }).then(()=>{
      db.collection('history').add({ action:'updSdt', id, field:f, value:payload[f], by:'public', ts: firebase.firestore.FieldValue.serverTimestamp()});
    }).catch(e=>console.error(e));
  }

  function refreshNow(){ subscribeSdtList(); subscribeLists(); }
  </script>
</body>
</html>