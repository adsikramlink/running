<!DOCTYPE html>
<html lang="id">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Efektivitas Running - Final</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; background:#f1f5f9; color:#0f172a; margin:0; padding-bottom:110px }
    .input-base{width:100%;background:white;border:1px solid #cbd5e1;border-radius:8px;padding:8px;font-weight:700}
    .chip-div{padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:white;color:#64748b;font-weight:700}
    .tab-btn{padding:6px 12px;border-radius:6px;font-weight:700;color:#64748b}
    .tab-btn.active{background:#fff;color:#0f172a;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .page{display:none}.page.active{display:block}
    .time-digit{width:32px;text-align:center;border:none;background:transparent;font-weight:700}
    .time-box{display:flex;gap:4px;align-items:center;justify-content:center;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:6px}
    .table-input{width:100%;text-align:center;border:none;border-bottom:2px solid #e2e8f0;padding:6px;font-weight:700}
    .hidden{display:none!important}
  </style>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, query, orderBy } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // config (sesuaikan bila perlu)
    const firebaseConfig = {
      apiKey: "AIzaSyDGPkoewPcjffZ8ORwB3rrVAKiYtRYzuEk",
      authDomain: "retase-20ec2.firebaseapp.com",
      projectId: "retase-20ec2",
      storageBucket: "retase-20ec2.firebasestorage.app",
      messagingSenderId: "414104675676",
      appId: "1:414104675676:web:95f0012dadfb1743ff8d99",
      measurementId: "G-64RN0GNMPW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // expose helpers for main (non-module) script below
    window._db = db;
    window._doc = doc;
    window._set = setDoc;
    window._get = getDoc;
    window._listen = onSnapshot;
    window._col = collection;
    window._add = addDoc;
    window._delete = deleteDoc;
    window._update = updateDoc;
    window._query = query;
    window._orderBy = orderBy;
  </script>
</head>
<body class="pb-32">

  <!-- ============ HOME ============ -->
  <div id="page-home" class="page active">
    <div class="bg-slate-900 text-white sticky top-0 z-50 p-4 flex justify-between items-center">
      <div>
        <h1 class="text-lg font-bold">Efektivitas Running</h1>
        <div class="text-slate-400 text-[11px]">Dashboard</div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btn-admin" title="Admin" class="p-2 rounded hover:bg-slate-800" onclick="navTo('admin')">
          <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
        <button id="btn-down" title="Bawah" class="p-2 rounded hidden">
          <i data-lucide="arrow-down" class="w-5 h-5"></i>
        </button>
      </div>
    </div>

    <main class="max-w-3xl mx-auto px-4 mt-6">
      <section class="bg-white p-4 rounded-lg shadow mb-4">
        <div class="flex justify-between items-center">
          <div>
            <div class="font-bold">Riwayat Terakhir</div>
            <div class="text-xs text-slate-500">Memuat history...</div>
          </div>
          <div id="history-count" class="text-slate-400 font-bold">0</div>
        </div>
      </section>

      <div id="history-list"></div>

      <div id="empty-history" class="text-center text-slate-400 mt-20">
        <div style="font-size:40px">üìÇ</div>
        Belum ada riwayat
      </div>
    </main>

    <!-- FAB -->
    <button id="fab" onclick="navTo('form')" class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow text-3xl">+</button>
  </div>

  <!-- ============ ADMIN ============ -->
  <div id="page-admin" class="page">
    <div class="bg-slate-900 text-white sticky top-0 z-50 p-4 flex items-center gap-4">
      <button onclick="navTo('home')" class="p-1"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
      <h2 class="font-bold text-lg">Admin - Tambah Data Master</h2>
    </div>

    <main class="max-w-3xl mx-auto px-4 mt-6 space-y-6">
      <!-- repeatables: spv/frm/chk/unit/driver -->
      <div class="bg-white p-4 rounded-lg shadow">
        <div class="font-bold mb-2">Supervisor</div>
        <div id="admin-spv-list" class="text-xs text-slate-600 mb-2"></div>
        <div class="flex gap-2">
          <input id="admin-spv-inp" class="input-base" placeholder="Tambah Supervisor">
          <button class="bg-indigo-600 text-white px-3 rounded" onclick="addAdminItem('spv')">Tambah</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <div class="font-bold mb-2">Foreman</div>
        <div id="admin-frm-list" class="text-xs text-slate-600 mb-2"></div>
        <div class="flex gap-2">
          <input id="admin-frm-inp" class="input-base" placeholder="Tambah Foreman">
          <button class="bg-indigo-600 text-white px-3 rounded" onclick="addAdminItem('frm')">Tambah</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <div class="font-bold mb-2">Checker</div>
        <div id="admin-chk-list" class="text-xs text-slate-600 mb-2"></div>
        <div class="flex gap-2">
          <input id="admin-chk-inp" class="input-base" placeholder="Tambah Checker">
          <button class="bg-indigo-600 text-white px-3 rounded" onclick="addAdminItem('chk')">Tambah</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <div class="font-bold mb-2">Unit SDT</div>
        <div id="admin-unit-list" class="text-xs text-slate-600 mb-2"></div>
        <div class="flex gap-2">
          <input id="admin-unit-inp" class="input-base" placeholder="Tambah Unit">
          <button class="bg-indigo-600 text-white px-3 rounded" onclick="addAdminItem('unit')">Tambah</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <div class="font-bold mb-2">Driver SDT</div>
        <div id="admin-driver-list" class="text-xs text-slate-600 mb-2"></div>
        <div class="flex gap-2">
          <input id="admin-driver-inp" class="input-base" placeholder="Tambah Driver">
          <button class="bg-indigo-600 text-white px-3 rounded" onclick="addAdminItem('driver')">Tambah</button>
        </div>
      </div>

      <div>
        <button class="w-full py-3 bg-green-600 text-white font-bold rounded-xl" onclick="saveAdminMaster()">Simpan ke Server</button>
      </div>

    </main>
  </div>

  <!-- ============ FORM ============ -->
  <div id="page-form" class="page">
    <div class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex items-center gap-4">
      <button onclick="navTo('home')" class="p-1"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
      <h2 class="font-bold text-lg">Input Efektivitas Running</h2>
    </div>

    <main class="max-w-3xl mx-auto px-4 mt-6 space-y-6">

      <!-- 0. Data Operasional -->
      <section class="bg-white rounded-xl shadow border">
        <div class="bg-slate-50 p-3 border-b font-bold">0. Data Operasional</div>
        <div class="p-4 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-bold text-slate-400">Shift</label>
              <select id="inputShift" class="input-base">
                <option value="NIGHT SHIFT">üåô NIGHT SHIFT</option>
                <option value="DAY SHIFT">‚òÄÔ∏è DAY SHIFT</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-400">Tanggal</label>
              <input type="date" id="inputTanggal" class="input-base">
            </div>
          </div>

          <div>
            <label class="text-xs font-bold text-slate-400">Supervisor</label>
            <div id="spvContainer" class="flex flex-wrap gap-2 my-2"></div>
            <input id="inputSupervisorLainnya" placeholder="+ Manual" class="w-full border-b py-1">
          </div>

          <div>
            <label class="text-xs font-bold text-slate-400">Foreman</label>
            <div id="foremanContainer" class="flex flex-wrap gap-2 my-2"></div>
            <input id="inputForemanLainnya" placeholder="+ Manual" class="w-full border-b py-1">
          </div>

          <div>
            <label class="text-xs font-bold text-slate-400">Checker</label>
            <div id="checkerContainer" class="flex flex-wrap gap-2 my-2"></div>
            <input id="inputCheckerLainnya" placeholder="+ Manual" class="w-full border-b py-1">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-3 rounded border">
              <label class="text-xs font-bold text-blue-600">TIPPING ROM</label>
              <input id="inputTippingRom" type="number" class="w-full text-xl font-black bg-transparent outline-none" placeholder="0">
            </div>
            <div class="bg-emerald-50 p-3 rounded border">
              <label class="text-xs font-bold text-emerald-600">TRANSFER ROM</label>
              <input id="inputTransferRom" type="number" class="w-full text-xl font-black bg-transparent outline-none" placeholder="0">
            </div>
          </div>
        </div>
      </section>

      <!-- 1. Durasi Conveyor (ringkasan) -->
      <section class="bg-white rounded-xl shadow border">
        <div class="bg-slate-50 p-3 flex justify-between items-center border-b">
          <div>
            <div class="font-bold">1. Durasi Conveyor</div>
            <div class="text-xs text-slate-400">Hitung Waktu Indikasi</div>
          </div>
          <div class="flex bg-slate-200 p-1 rounded">
            <button id="tab-SD1" class="tab-btn active" onclick="switchTab('SD1')">SD1</button>
            <button id="tab-SD2" class="tab-btn" onclick="switchTab('SD2')">SD2</button>
            <button id="tab-SD3" class="tab-btn" onclick="switchTab('SD3')">SD3</button>
          </div>
        </div>

        <div class="p-4">
          <div class="grid grid-cols-12 gap-2 text-xs font-bold text-slate-400 text-center mb-2">
            <div class="col-span-1">#</div>
            <div class="col-span-5">Mulai</div>
            <div class="col-span-5">Selesai</div>
            <div class="col-span-1">Del</div>
          </div>

          <div id="container-SD1" class="space-y-2"></div>
          <div id="container-SD2" class="space-y-2 hidden"></div>
          <div id="container-SD3" class="space-y-2 hidden"></div>

          <button onclick="addTimeRow(activeSD)" class="mt-4 w-full py-3 border border-dashed rounded text-slate-500">+ Tambah Baris</button>

          <div id="results" class="mt-6 grid grid-cols-3 gap-2">
            <div class="bg-slate-50 p-2 rounded text-center border">
              <div class="text-xs text-slate-400">SD1 Indikasi</div>
              <div id="res-SD1" class="text-sm font-black">0j 0m</div>
              <div id="eff-SD1" class="text-[10px] font-bold text-emerald-600" data-copy="-">12j 0m</div>
            </div>
            <div class="bg-slate-50 p-2 rounded text-center border">
              <div class="text-xs text-slate-400">SD2 Indikasi</div>
              <div id="res-SD2" class="text-sm font-black">0j 0m</div>
              <div id="eff-SD2" class="text-[10px] font-bold text-emerald-600" data-copy="-">12j 0m</div>
            </div>
            <div class="bg-slate-50 p-2 rounded text-center border">
              <div class="text-xs text-slate-400">SD3 Indikasi</div>
              <div id="res-SD3" class="text-sm font-black">0j 0m</div>
              <div id="eff-SD3" class="text-[10px] font-bold text-emerald-600" data-copy="-">12j 0m</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 2. Unit Running (ringkasan) -->
      <section class="bg-white rounded-xl shadow border">
        <div class="bg-slate-50 p-3 border-b font-bold">2. Perhitungan Unit Running</div>
        <div class="p-4 space-y-4">
          <!-- MHA -->
          <div>
            <div class="text-xs font-bold text-slate-600 mb-1">MHA</div>
            <div class="border rounded overflow-hidden text-xs">
              <div class="grid grid-cols-12 bg-slate-50 text-slate-400 py-2 border-b text-xs">
                <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HASIL</div>
              </div>
              <div class="grid grid-cols-12 py-1 items-center border-b">
                <div class="col-span-2">‚òÄÔ∏è</div>
                <div class="col-span-4 px-1"><input id="mha-run-siang" class="table-input" oninput="calcUnit('mha')"></div>
                <div class="col-span-4 px-1"><input id="mha-trip-siang" class="table-input" oninput="calcUnit('mha')"></div>
                <div class="col-span-2 font-black" id="mha-res-siang">0</div>
              </div>
              <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
                <div class="col-span-2">üåô</div>
                <div class="col-span-4 px-1"><input id="mha-run-malam" class="table-input" oninput="calcUnit('mha')"></div>
                <div class="col-span-4 px-1"><input id="mha-trip-malam" class="table-input" oninput="calcUnit('mha')"></div>
                <div class="col-span-2 font-black" id="mha-res-malam">0</div>
              </div>
            </div>
          </div>

          <!-- KARUNIA -->
          <div>
            <div class="text-xs font-bold text-slate-600 mb-1">KARUNIA</div>
            <div class="border rounded overflow-hidden text-xs">
              <div class="grid grid-cols-12 bg-slate-50 text-slate-400 py-2 border-b text-xs">
                <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HASIL</div>
              </div>
              <div class="grid grid-cols-12 py-1 items-center border-b">
                <div class="col-span-2">‚òÄÔ∏è</div>
                <div class="col-span-4 px-1"><input id="kai-run-siang" class="table-input" oninput="calcUnit('kai')"></div>
                <div class="col-span-4 px-1"><input id="kai-trip-siang" class="table-input" oninput="calcUnit('kai')"></div>
                <div class="col-span-2 font-black" id="kai-res-siang">0</div>
              </div>
              <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
                <div class="col-span-2">üåô</div>
                <div class="col-span-4 px-1"><input id="kai-run-malam" class="table-input" oninput="calcUnit('kai')"></div>
                <div class="col-span-4 px-1"><input id="kai-trip-malam" class="table-input" oninput="calcUnit('kai')"></div>
                <div class="col-span-2 font-black" id="kai-res-malam">0</div>
              </div>
            </div>
          </div>

          <!-- BUMA -->
          <div>
            <div class="text-xs font-bold text-slate-600 mb-1">BUMA</div>
            <div class="border rounded overflow-hidden text-xs">
              <div class="grid grid-cols-12 bg-slate-50 text-slate-400 py-2 border-b text-xs">
                <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HASIL</div>
              </div>
              <div class="grid grid-cols-12 py-1 items-center border-b">
                <div class="col-span-2">‚òÄÔ∏è</div>
                <div class="col-span-4 px-1"><input id="buma-run-siang" class="table-input" oninput="calcUnit('buma')"></div>
                <div class="col-span-4 px-1"><input id="buma-trip-siang" class="table-input" oninput="calcUnit('buma')"></div>
                <div class="col-span-2 font-black" id="buma-res-siang">0</div>
              </div>
              <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
                <div class="col-span-2">üåô</div>
                <div class="col-span-4 px-1"><input id="buma-run-malam" class="table-input" oninput="calcUnit('buma')"></div>
                <div class="col-span-4 px-1"><input id="buma-trip-malam" class="table-input" oninput="calcUnit('buma')"></div>
                <div class="col-span-2 font-black" id="buma-res-malam">0</div>
              </div>
            </div>
          </div>

          <div class="bg-slate-100 p-3 rounded flex justify-between items-center">
            <span class="font-bold text-slate-500">Total Hauling</span>
            <span id="grand-total" class="font-black text-indigo-700">0 Trip</span>
          </div>

        </div>
      </section>

      <!-- 3. SDT -->
      <section class="bg-white rounded-xl shadow border">
        <div class="bg-slate-50 p-3 border-b flex justify-between items-center">
          <div class="font-bold">3. Unit SDT Running</div>
          <button onclick="toggleConfig()" class="text-xs text-blue-600 underline">Config</button>
        </div>

        <div class="p-4">
          <div id="configPanel" class="hidden mb-4 bg-blue-50 p-3 rounded">
            <div class="grid grid-cols-2 gap-2">
              <div class="flex gap-2">
                <input id="newUnit" class="input-base py-1" placeholder="Unit Baru">
                <button class="bg-blue-600 text-white px-3 rounded" onclick="addMaster('unit')">Tambah</button>
              </div>
              <div class="flex gap-2">
                <input id="newDriver" class="input-base py-1" placeholder="Driver Baru">
                <button class="bg-emerald-600 text-white px-3 rounded" onclick="addMaster('driver')">Tambah</button>
              </div>
            </div>
          </div>

          <div id="unitBtnContainer" class="flex flex-wrap gap-2 mb-4"></div>

          <div id="sdtList" class="space-y-3"></div>
          <div id="emptyMsg" class="text-center text-slate-300 italic border-dashed p-4 rounded">Belum ada data. Klik tombol unit di atas.</div>
        </div>
      </section>

      <div class="grid grid-cols-2 gap-3 mt-6 mb-16">
        <button class="bg-white border border-purple-200 text-purple-700 font-bold py-3 rounded-xl" onclick="copyReport(false)">Salin SIANG</button>
        <button class="bg-white border border-indigo-200 text-indigo-700 font-bold py-3 rounded-xl" onclick="copyReport(true)">Salin MALAM</button>
        <button class="col-span-2 bg-indigo-600 text-white py-3 rounded-xl font-bold" onclick="saveHistory()">SIMPAN HISTORY</button>
      </div>

    </main>
  </div>

  <!-- toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-2 rounded hidden">Teks disalin</div>

<script>
/* ---------------------------
  GLOBAL STATE (master + form)
----------------------------*/
let masterSPV=[], masterFRM=[], masterCHK=[], masterUnits=[], masterDrivers=[];
let conveyorData = {SD1:[], SD2:[], SD3:[]}, activeSD='SD1';
let sdtData = [];

/* ---------------------------
  NAV
----------------------------*/
function navTo(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  // ensure icons render
  if(window.lucide) lucide.createIcons();
  if(page==='form') initFormUI();
  if(page==='admin') renderAdminPanel();
}

/* ---------------------------
  MASTER: render chips & admin lists
----------------------------*/
function initChips(container, list){
  const el=document.getElementById(container);
  if(!el) return;
  el.innerHTML = list.map(n=>`<label class="inline-block"><input type="checkbox" class="hidden" value="${n}"><div class="chip-div">${n}</div></label>`).join('');
}
function renderUnitButtons(){
  const wrap=document.getElementById('unitBtnContainer'); if(!wrap) return;
  wrap.innerHTML = masterUnits.map(u=>`<button class="bg-white border px-3 py-1 rounded text-xs" onclick="addSdt('${u}')">${u}</button>`).join('');
}
function renderAdminPanel(){
  document.getElementById('admin-spv-list').innerHTML = masterSPV.map((n,i)=>`<div class="flex justify-between items-center text-xs"><div>- ${n}</div><button onclick="delMasterItem('spv',${i})" class="text-red-500 text-xs">hapus</button></div>`).join('');
  document.getElementById('admin-frm-list').innerHTML = masterFRM.map((n,i)=>`<div class="flex justify-between items-center text-xs"><div>- ${n}</div><button onclick="delMasterItem('frm',${i})" class="text-red-500 text-xs">hapus</button></div>`).join('');
  document.getElementById('admin-chk-list').innerHTML = masterCHK.map((n,i)=>`<div class="flex justify-between items-center text-xs"><div>- ${n}</div><button onclick="delMasterItem('chk',${i})" class="text-red-500 text-xs">hapus</button></div>`).join('');
  document.getElementById('admin-unit-list').innerHTML = masterUnits.map((n,i)=>`<div class="flex justify-between items-center text-xs"><div>- ${n}</div><button onclick="delMasterItem('unit',${i})" class="text-red-500 text-xs">hapus</button></div>`).join('');
  document.getElementById('admin-driver-list').innerHTML = masterDrivers.map((n,i)=>`<div class="flex justify-between items-center text-xs"><div>- ${n}</div><button onclick="delMasterItem('driver',${i})" class="text-red-500 text-xs">hapus</button></div>`).join('');
}

/* ---------------------------
  CRUD MASTER (local edit + save to firestore)
----------------------------*/
function addAdminItem(type){
  const inp = document.getElementById(`admin-${type}-inp`);
  if(!inp) return;
  const v = inp.value.trim(); if(!v) return inp.value='';
  if(type==='spv') masterSPV.push(v);
  if(type==='frm') masterFRM.push(v);
  if(type==='chk') masterCHK.push(v);
  if(type==='unit') masterUnits.push(v.toUpperCase());
  if(type==='driver') masterDrivers.push(v);
  inp.value='';
  renderAdminPanel(); initChips('spvContainer', masterSPV); initChips('foremanContainer', masterFRM); initChips('checkerContainer', masterCHK); renderUnitButtons();
}

async function saveAdminMaster(){
  try{
    const db = window._db;
    const ref = window._doc(db, 'settings', 'lists');
    await window._set(ref, { spv:masterSPV, frm:masterFRM, chk:masterCHK, unit:masterUnits, driver:masterDrivers, _adminKey:'mpadmin' }, { merge:true });
    alert('Master tersimpan ke server');
  }catch(e){ console.error(e); alert('Gagal menyimpan master. Lihat console.'); }
}

async function delMasterItem(type, idx){
  if(!confirm('Hapus item ini?')) return;
  if(type==='spv') masterSPV.splice(idx,1);
  if(type==='frm') masterFRM.splice(idx,1);
  if(type==='chk') masterCHK.splice(idx,1);
  if(type==='unit') masterUnits.splice(idx,1);
  if(type==='driver') masterDrivers.splice(idx,1);
  renderAdminPanel(); initChips('spvContainer', masterSPV); initChips('foremanContainer', masterFRM); initChips('checkerContainer', masterCHK); renderUnitButtons();
  // auto-save change
  try{ await saveAdminMaster(); }catch(e){ console.warn('auto-save master failed', e); }
}

/* ---------------------------
  Load master realtime from firestore
----------------------------*/
async function loadMasterRealtime(){
  try{
    const db = window._db;
    const ref = window._doc(db,'settings','lists');
    window._listen(ref, snap=>{
      if(!snap.exists()) return;
      const d = snap.data();
      masterSPV = d.spv || []; masterFRM = d.frm || []; masterCHK = d.chk || []; masterUnits = d.unit || []; masterDrivers = d.driver || [];
      initChips('spvContainer', masterSPV); initChips('foremanContainer', masterFRM); initChips('checkerContainer', masterCHK); renderUnitButtons(); renderAdminPanel();
    });
  }catch(e){ console.error('loadMasterRealtime',e); alert('Error load master (see console)'); }
}

/* ---------------------------
  FORM (conveyor / sdt)
----------------------------*/
function initFormUI(){
  // date default
  const d = document.getElementById('inputTanggal');
  if(d && !d.value) d.value = new Date().toISOString().slice(0,10);
  // ensure minimal conveyor rows
  if(conveyorData.SD1.length===0 && conveyorData.SD2.length===0 && conveyorData.SD3.length===0){
    addTimeRow('SD1'); addTimeRow('SD1'); addTimeRow('SD2'); addTimeRow('SD3');
  }
  renderSdtList();
  if(window.lucide) lucide.createIcons();
}

function switchTab(sd){
  activeSD = sd;
  ['SD1','SD2','SD3'].forEach(x=>{
    document.getElementById('tab-'+x).classList.toggle('active', x===sd);
    document.getElementById('container-'+x).classList.toggle('hidden', x!==sd);
  });
}

function addTimeRow(sd){
  const idx = conveyorData[sd].length;
  conveyorData[sd].push({sh:'',sm:'',fh:'',fm:''});
  const div = document.createElement('div');
  div.id = `row-${sd}-${idx}`;
  div.className = 'grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border';
  div.innerHTML = `<div class="col-span-1 text-xs text-slate-400">${idx+1}</div>
    <div class="col-span-5 time-box"><input maxlength="2" oninput="updTime('${sd}',${idx},'sh',this)" class="time-digit" placeholder="HH">:<input maxlength="2" oninput="updTime('${sd}',${idx},'sm',this)" class="time-digit" placeholder="MM"></div>
    <div class="col-span-5 time-box"><input maxlength="2" oninput="updTime('${sd}',${idx},'fh',this)" class="time-digit" placeholder="HH">:<input maxlength="2" oninput="updTime('${sd}',${idx},'fm',this)" class="time-digit" placeholder="MM"></div>
    <div class="col-span-1 text-center"><button onclick="delTimeRow('${sd}',${idx})" class="text-red-400 font-bold">√ó</button></div>`;
  document.getElementById('container-'+sd).appendChild(div);
}

function updTime(sd, idx, f, el){
  let v = el.value.replace(/\D/g,''); if(v.length>2) v=v.slice(0,2);
  if((f==='sh'||f==='fh') && Number(v)>23) v='23';
  if((f==='sm'||f==='fm') && Number(v)>59) v='59';
  el.value = v; conveyorData[sd][idx][f]=v; calcConv(sd);
}

function delTimeRow(sd, idx){
  const el=document.getElementById(`row-${sd}-${idx}`); if(el) el.remove();
  conveyorData[sd][idx] = {sh:'',sm:'',fh:'',fm:''}; calcConv(sd);
}

function calcConv(sd){
  let tot = 0;
  conveyorData[sd].forEach(r=>{
    if(r.sh && r.sm && r.fh && r.fm){
      let s = parseInt(r.sh)*60 + parseInt(r.sm), f = parseInt(r.fh)*60 + parseInt(r.fm);
      if(f<s) f+=1440; tot += (f-s);
    }
  });
  const th = Math.floor(tot/60), tm = tot%60;
  const res = document.getElementById('res-'+sd); if(res) res.innerText = `${th}j ${tm}m`;
  let rem = (12*60) - tot, rh = Math.floor(Math.abs(rem)/60), rm = Math.abs(rem)%60;
  const eff = document.getElementById('eff-'+sd);
  if(!eff) return;
  if(tot===0){ eff.innerText='-'; eff.dataset.copy='-'; }
  else if(rem>=0){ eff.innerText=`${rh}j ${rm}m`; eff.dataset.copy = `${rh} Jam ${rm} Menit`;}
  else { eff.innerText=`${rh}j ${rm}m (Over)`; eff.dataset.copy = `${rh} Jam ${rm} Menit (Over)`;}
}

/* ---------------------------
  UNIT running calc
----------------------------*/
function calcUnit(id){
  const val = (id)=> parseFloat(document.getElementById(id).value)||0;
  const rs = val(`${id}-run-siang`), ts = val(`${id}-trip-siang`), rm = val(`${id}-run-malam`), tm=val(`${id}-trip-malam`);
  if(document.getElementById(`${id}-res-siang`)) document.getElementById(`${id}-res-siang`).innerText = (ts - rs);
  if(document.getElementById(`${id}-res-malam`)) document.getElementById(`${id}-res-malam`).innerText = ((tm - ts) - rm);
  // grand total trips (simple)
  const mt = (parseFloat(document.getElementById('mha-trip-malam').value)||0) - (parseFloat(document.getElementById('mha-trip-siang').value)||0);
  const kt = (parseFloat(document.getElementById('kai-trip-malam').value)||0) - (parseFloat(document.getElementById('kai-trip-siang').value)||0);
  const bt = (parseFloat(document.getElementById('buma-trip-malam').value)||0) - (parseFloat(document.getElementById('buma-trip-siang').value)||0);
  const total = (isNaN(mt)?0:mt) + (isNaN(kt)?0:kt) + (isNaN(bt)?0:bt);
  document.getElementById('grand-total').innerText = (total>0? total + ' Trip' : '0 Trip');
}

/* ---------------------------
  SDT list actions
----------------------------*/
function addSdt(u){
  sdtData.push({ unit:u, driver:'', trip:'', ket:'' });
  renderSdtList();
}
function delSdt(i){ if(!confirm('Hapus SDT ini?')) return; sdtData.splice(i,1); renderSdtList(); }
function updSdt(i,f,val){ sdtData[i][f]=val; }
function renderSdtList(){
  const c = document.getElementById('sdtList'), empty=document.getElementById('emptyMsg');
  if(sdtData.length===0){ c.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  const drvOpts = `<option value="">Driver...</option>` + masterDrivers.map(d=>`<option value="${d}">${d}</option>`).join('');
  c.innerHTML = sdtData.map((d,i)=>`
    <div class="bg-white p-2 rounded border">
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold text-xs bg-indigo-100 text-indigo-700 px-2 rounded">${d.unit}</div>
        <div><button class="text-red-500 text-xs" onclick="delSdt(${i})">Hapus</button></div>
      </div>
      <div class="grid grid-cols-12 gap-2 text-xs">
        <div class="col-span-5">
          <select onchange="updSdt(${i},'driver',this.value)" class="w-full p-1 border rounded">${drvOpts.replace(`value="${d.driver}"`,`value="${d.driver}" selected`)}</select>
        </div>
        <div class="col-span-3"><input type="number" value="${d.trip}" oninput="updSdt(${i},'trip',this.value)" class="w-full border rounded p-1 text-center font-bold"></div>
        <div class="col-span-4"><input value="${d.ket}" oninput="updSdt(${i},'ket',this.value)" placeholder="Ket..." class="w-full border rounded p-1 italic text-red-500"></div>
      </div>
    </div>`).join('');
  if(window.lucide) lucide.createIcons();
}

/* ---------------------------
  Copy report (format sesuai contoh)
----------------------------*/
function copyReport(isMalam){
  const shift = document.getElementById('inputShift').value;
  const d = document.getElementById('inputTanggal').value.split('-');
  const bulan = ["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGU","SEP","OKT","NOV","DES"];
  const fmt = d.length===3 ? `${d[2]}/${bulan[parseInt(d[1])-1]}/${d[0].slice(-2)}` : '-';

  const spv = getChecked('spvContainer');
  const frm = getChecked('foremanContainer');
  const chk = getChecked('checkerContainer');

  const effLines = ['SD1','SD2','SD3'].map(sd=>{
    const copy = document.getElementById('eff-'+sd).dataset.copy || '-';
    return `- ${sd} = ${copy}`;
  }).join('\n');

  const val = id => parseFloat(document.getElementById(id).value)||0;
  const calcTrip = (b) => isMalam ? (val(`${b}-trip-malam`)-val(`${b}-trip-siang`)) : val(`${b}-trip-siang`);
  const mt = calcTrip('mha'), kt = calcTrip('kai'), bt = calcTrip('buma');
  const tip = val('inputTippingRom'), trans = val('inputTransferRom');
  const totalHaul = (mt||0)+(kt||0)+(bt||0);

  let sdtLines = sdtData.length ? sdtData.map(x=>`- ${x.unit} (${x.driver||'-'}) : ${x.trip? x.trip+' Trip' : '- Trip'}`).join('\n') : '-';

  const txt = `*CHP OPERATION*\n*${shift}*\n*${fmt}*\n\n*Supervisor* : ${spv||'-'}\n*Foreman* : ${frm||'-'}\n*Checker* : ${chk||'-'}\n\n*Efektivitas RUNNING*\n${effLines}\n\n*HAULING*\n- MHA   = ${mt||0} TRIP\n- KARUNIA = ${kt||0} TRIP\n- BUMA  = ${bt||0} TRIP\n\n*UNIT 2 TRIP*\n- MHA   = ${document.getElementById('mha-res-'+(isMalam?'malam':'siang')).innerText||'0'} Unit\n- KARUNIA = ${document.getElementById('kai-res-'+(isMalam?'malam':'siang')).innerText||'0'} Unit\n- BUMA  = ${document.getElementById('buma-res-'+(isMalam?'malam':'siang')).innerText||'0'} Unit\n\n*TRIP SDT TRANSFER*\n${sdtLines}\n\n*TOTAL HAULING   = ${totalHaul} Trip*\n*TIPPING ROM        = ${tip} Trip*\n*TRANSFER ROM   = ${trans} Trip*\n*TRANSFER ROM + HAULING = ${trans + totalHaul} Trip*`;

  copyToClipboard(txt);
}

function copyToClipboard(t){
  const ta = document.createElement('textarea'); ta.value = t; document.body.appendChild(ta); ta.select();
  document.execCommand('copy'); document.body.removeChild(ta);
  const toast = document.getElementById('toast'); toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),1500);
}

/* ---------------------------
  Firestore: save history & realtime load + delete
----------------------------*/
async function saveHistory(){
  try{
    const db = window._db;
    const ref = window._col(db,'history');
    const rec = {
      date: document.getElementById('inputTanggal').value,
      shift: document.getElementById('inputShift').value,
      total: document.getElementById('grand-total').innerText || '0',
      createdAt: Date.now(),
      // optional: add raw details (for viewing later)
      details: {
        spv: getChecked('spvContainer'),
        frm: getChecked('foremanContainer'),
        chk: getChecked('checkerContainer'),
        eff: {
          SD1: document.getElementById('eff-SD1').dataset.copy || '-',
          SD2: document.getElementById('eff-SD2').dataset.copy || '-',
          SD3: document.getElementById('eff-SD3').dataset.copy || '-'
        },
        hauling: {
          mha_si: document.getElementById('mha-trip-siang')?.value||0,
          mha_ma: document.getElementById('mha-trip-malam')?.value||0,
          kai_si: document.getElementById('kai-trip-siang')?.value||0,
          kai_ma: document.getElementById('kai-trip-malam')?.value||0,
          buma_si: document.getElementById('buma-trip-siang')?.value||0,
          buma_ma: document.getElementById('buma-trip-malam')?.value||0
        },
        sdt: sdtData
      }
    };
    await window._add(ref, rec);
    alert('Form berhasil disimpan!');
    navTo('home');
  }catch(e){ console.error('saveHistory', e); alert('Gagal menyimpan history.'); }
}

function loadHistoryRealtime(){
  try{
    const db = window._db;
    const ref = window._col(db,'history');
    const q = window._query(ref, window._orderBy('createdAt','desc'));
    window._listen(q, snap=>{
      const list = document.getElementById('history-list'); let html='';
      let count=0;
      snap.forEach(doc=>{
        const d = doc.data(); count++;
        html += `<div class="bg-white p-3 rounded-lg mb-2 border flex justify-between items-start">
          <div>
            <div class="font-bold">${d.date}</div>
            <div class="text-xs text-slate-500">${d.shift}</div>
            <div class="text-sm mt-1 font-semibold text-indigo-700">Total: ${d.total}</div>
          </div>
          <div class="flex flex-col gap-1 items-end">
            <button onclick="viewHistory('${doc.id}')" class="text-xs px-2 py-1 bg-indigo-50 text-indigo-700 rounded">Buka</button>
            <button onclick="deleteHistory('${doc.id}')" class="text-xs px-2 py-1 bg-red-50 text-red-600 rounded">Hapus</button>
          </div>
        </div>`;
      });
      list.innerHTML = html;
      document.getElementById('history-count').innerText = count;
      document.getElementById('empty-history').style.display = count>0? 'none':'block';
    });
  }catch(e){ console.error('loadHistoryRealtime', e); }
}

async function deleteHistory(id){
  if(!confirm('Hapus history ini?')) return;
  try{ await window._delete(window._doc(window._db,'history',id)); alert('Terhapus'); }
  catch(e){ console.error('deleteHistory',e); alert('Gagal hapus'); }
}

async function viewHistory(id){
  // baca doc, isi form, buka page form
  try{
    const snap = await window._get(window._doc(window._db,'history',id));
    if(!snap.exists()) return alert('Data tidak ditemukan');
    const d = snap.data();
    // isi form (sederhana, gunakan fields yang ada)
    document.getElementById('inputTanggal').value = d.date || '';
    document.getElementById('inputShift').value = d.shift || 'NIGHT SHIFT';
    // jika ada details, isi spv/frm/chk/sdt
    if(d.details){
      const det = d.details;
      // set checked chips by matching text (simple: set manual inputs)
      document.getElementById('inputSupervisorLainnya').value = det.spv || '';
      document.getElementById('inputForemanLainnya').value = det.frm || '';
      document.getElementById('inputCheckerLainnya').value = det.chk || '';
      // sdt
      sdtData = (det.sdt && Array.isArray(det.sdt))? det.sdt : [];
      renderSdtList();
      // eff copy not parse back to inputs (we show indicator)
    }
    navTo('form');
  }catch(e){ console.error('viewHistory', e); alert('Gagal memuat history'); }
}

/* ---------------------------
  small helpers
----------------------------*/
function getChecked(containerId){
  const arr = Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(i=>i.parentElement.innerText.trim());
  let manual = '';
  if(containerId.includes('spv')) manual = document.getElementById('inputSupervisorLainnya').value.trim();
  if(containerId.includes('foreman')) manual = document.getElementById('inputForemanLainnya').value.trim();
  if(containerId.includes('checker')) manual = document.getElementById('inputCheckerLainnya').value.trim();
  if(manual) arr.push(manual);
  return arr.join(', ');
}

function toggleConfig(){ document.getElementById('configPanel').classList.toggle('hidden'); }
function addMaster(t){
  if(t==='unit'){ const v=document.getElementById('newUnit').value.trim(); if(!v) return; masterUnits.push(v.toUpperCase()); document.getElementById('newUnit').value=''; }
  if(t==='driver'){ const v=document.getElementById('newDriver').value.trim(); if(!v) return; masterDrivers.push(v); document.getElementById('newDriver').value=''; }
  renderUnitButtons(); renderAdminPanel();
}

/* ---------------------------
  INIT: load master + history
----------------------------*/
window.onload = async ()=>{
  try{
    await loadMasterRealtime();
    loadHistoryRealtime();
    if(window.lucide) lucide.createIcons();
  }catch(e){ console.error('onload',e); }
};
</script>

  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("service-worker.js")
    .then(() => console.log("Service Worker registered"));
}
  </script>

</body>
</html>
