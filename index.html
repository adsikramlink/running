<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Efektivitas Running - Single File (Firestore)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  body { font-family:'Inter',sans-serif; background:#f1f5f9; color:#1e293b; margin:0; padding-bottom:100px;}
  .input-base{width:100%;background:white;border:1px solid #cbd5e1;border-radius:6px;padding:8px;font-weight:600;outline:none;transition:0.2s;}
  .input-base:focus{border-color:#4f46e5;box-shadow:0 0 0 2px rgba(79,70,229,.1);}
  .time-digit{width:32px;text-align:center;border:none;outline:none;font-weight:700;color:#334155;background:transparent;}
  .time-box{display:flex;align-items:center;justify-content:center;gap:2px;background:white;border:1px solid #e2e8f0;border-radius:6px;padding:4px;}
  .table-input{width:100%;text-align:center;background:transparent;border:none;border-bottom:2px solid #e2e8f0;font-weight:700;padding:4px;outline:none;}
  .table-input:focus{border-bottom-color:#4f46e5;background:#f8fafc;}
  .chip-div{padding:4px 10px;border-radius:99px;border:1px solid #cbd5e1;background:white;color:#64748b;font-size:11px;font-weight:700;transition:0.2s;cursor:pointer;}
  .chip-label input:checked + div{background:#4f46e5;color:white;border-color:#4f46e5;}
  .tab-btn{padding:6px 16px;border-radius:6px;font-size:12px;font-weight:700;color:#64748b;transition:0.2s;}
  .tab-btn.active{background:white;color:#1e293b;box-shadow:0 1px 3px rgba(0,0,0,.1);}
  .admin-badge{background:#10b981;color:white;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer;}
  .card{background:white;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05);overflow:hidden;}
  .card-head{background:#f8fafc;padding:10px 15px;font-weight:700;font-size:12px;color:#64748b;border-bottom:1px solid #e6eefb;text-transform:uppercase;}
  .card-body{padding:15px;}
  .hidden { display:none !important; }
  .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: none; z-index: 100; }
</style>
</head>
<body class="pb-32">

  <!-- NAVBAR -->
  <div class="bg-slate-900 text-white py-4 px-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
    <div>
      <h1 class="text-lg font-bold">Efektivitas Running</h1>
      <p class="text-slate-400 text-[10px]">Dashboard v3.0 Final</p>
    </div>
    <div class="flex items-center gap-3">
      <div id="adminToggle" class="admin-badge" title="Login Admin">Admin</div>
      <button id="btnScrollBottom" class="bg-indigo-600 hover:bg-indigo-700 text-xs font-bold py-2 px-3 rounded">‚Üì Bawah</button>
    </div>
  </div>

  <div class="max-w-3xl mx-auto px-4 mt-6 space-y-6">

    <!-- HISTORY PANEL (atas) -->
    <div id="historyPanel" class="card p-3">
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold">Riwayat Terakhir</div>
        <div id="historyCount" class="text-xs text-slate-500">0</div>
      </div>
      <div id="historyList" class="space-y-2 text-sm text-slate-600">Memuat history...</div>
    </div>

    <!-- ADMIN PANEL (di dalam index, hidden by default) -->
    <div id="adminPanel" class="card p-3 hidden">
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold">Admin - Tambah Data Master</div>
        <div style="font-size:12px;color:#64748b;cursor:pointer" onclick="closeAdmin()">Tutup</div>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-2">
        <select id="adminType" class="input-base">
          <option value="supervisor">Supervisor</option>
          <option value="foreman">Foreman</option>
          <option value="checker">Checker</option>
          <option value="unit">Unit</option>
          <option value="driver">Driver</option>
        </select>
        <input id="adminValue" class="input-base" placeholder="Masukkan nama / kode (mis. 01-F / Agus)">
      </div>

      <div class="flex gap-2">
        <button onclick="addPerson()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Tambah</button>
        <button onclick="reloadSettingsFromServer()" class="bg-white border border-slate-200 px-4 py-2 rounded font-bold">Refresh</button>
      </div>

      <div id="adminLists" class="mt-4 text-sm text-slate-600">
        <div><strong>Supervisor:</strong> <span id="listSpv">-</span></div>
        <div><strong>Foreman:</strong> <span id="listFrm">-</span></div>
        <div><strong>Checker:</strong> <span id="listChk">-</span></div>
        <div><strong>Unit:</strong> <span id="listUnit">-</span></div>
        <div><strong>Driver:</strong> <span id="listDriver">-</span></div>
      </div>
    </div>

    <!-- 0. DATA OPERASIONAL -->
    <section class="card">
      <div class="card-head">0. Data Operasional</div>
      <div class="card-body">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Shift</label>
            <select id="inputShift" class="input-base"><option value="NIGHT SHIFT">üåô NIGHT SHIFT</option><option value="DAY SHIFT">‚òÄÔ∏è DAY SHIFT</option></select>
          </div>
          <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Tanggal</label>
            <input type="date" id="inputTanggal" class="input-base">
          </div>
        </div>

        <div class="mt-3">
          <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Supervisor</label>
          <div id="spvContainer" class="flex flex-wrap gap-2 mb-2"></div>
          <input id="inputSupervisorLainnya" placeholder="+ Manual" class="text-sm w-full border-b py-1 outline-none focus:border-indigo-500">
        </div>

        <div class="mt-3">
          <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Foreman</label>
          <div id="foremanContainer" class="flex flex-wrap gap-2 mb-2"></div>
          <input id="inputForemanLainnya" placeholder="+ Manual" class="text-sm w-full border-b py-1 outline-none focus:border-indigo-500">
        </div>

        <div class="mt-3">
          <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Checker</label>
          <div id="checkerContainer" class="flex flex-wrap gap-2 mb-2"></div>
          <input id="inputCheckerLainnya" placeholder="+ Manual" class="text-sm w-full border-b py-1 outline-none focus:border-indigo-500">
        </div>

        <div class="grid grid-cols-2 gap-4 pt-2">
          <div class="bg-blue-50 p-3 rounded border border-blue-100">
            <label class="text-[10px] font-bold text-blue-600 block">TIPPING ROM</label>
            <input type="number" id="inputTippingRom" placeholder="0" class="w-full bg-transparent text-xl font-black text-blue-900 outline-none">
          </div>
          <div class="bg-emerald-50 p-3 rounded border border-emerald-100">
            <label class="text-[10px] font-bold text-emerald-600 block">TRANSFER ROM</label>
            <input type="number" id="inputTransferRom" placeholder="0" class="w-full bg-transparent text-xl font-black text-emerald-900 outline-none">
          </div>
        </div>
      </div>
    </section>

    <!-- 1. DURASI CONVEYOR -->
    <section class="card">
      <div class="card-head flex justify-between items-center">
        <div>
          <div class="font-bold text-slate-700">1. Durasi Conveyor</div>
          <div class="text-[10px] text-slate-400">Hitung Waktu Indikasi</div>
        </div>
        <div class="flex bg-slate-200 p-1 rounded-md">
          <button onclick="switchTab('SD1')" id="tab-SD1" class="tab-btn active">SD1</button>
          <button onclick="switchTab('SD2')" id="tab-SD2" class="tab-btn">SD2</button>
          <button onclick="switchTab('SD3')" id="tab-SD3" class="tab-btn">SD3</button>
        </div>
      </div>
      <div class="card-body">
        <div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-slate-400 text-center mb-2"><div class="col-span-1">#</div><div class="col-span-5">Mulai</div><div class="col-span-5">Selesai</div><div class="col-span-1">Del</div></div>
        <div id="container-SD1" class="space-y-2"></div>
        <div id="container-SD2" class="space-y-2 hidden"></div>
        <div id="container-SD3" class="space-y-2 hidden"></div>
        <button onclick="addTimeRow(activeSD)" class="mt-4 w-full py-3 border border-dashed border-slate-300 text-slate-500 font-bold text-xs rounded hover:bg-slate-50">+ Tambah Baris</button>

        <div id="results" class="mt-6 grid grid-cols-3 gap-2 border-t border-slate-100 pt-4">
          <div class="bg-slate-50 p-2 rounded text-center border border-slate-200"><div class="text-[10px] text-slate-400 font-bold">SD1 Indikasi</div><div id="res-SD1" class="text-sm font-black text-slate-800">0j 0m</div><div id="eff-SD1" class="text-[10px] font-bold text-emerald-600">12j 0m</div></div>
          <div class="bg-slate-50 p-2 rounded text-center border border-slate-200"><div class="text-[10px] text-slate-400 font-bold">SD2 Indikasi</div><div id="res-SD2" class="text-sm font-black text-slate-800">0j 0m</div><div id="eff-SD2" class="text-[10px] font-bold text-emerald-600">12j 0m</div></div>
          <div class="bg-slate-50 p-2 rounded text-center border border-slate-200"><div class="text-[10px] text-slate-400 font-bold">SD3 Indikasi</div><div id="res-SD3" class="text-sm font-black text-slate-800">0j 0m</div><div id="eff-SD3" class="text-[10px] font-bold text-emerald-600">12j 0m</div></div>
        </div>
      </div>
    </section>

    <!-- 2. UNIT RUNNING -->
    <section class="card">
      <div class="card-head">2. Perhitungan Unit Running</div>
      <div class="card-body space-y-6">
        <div>
          <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full bg-orange-500"></div><span class="text-xs font-bold text-slate-700">MHA</span></div>
          <div class="border border-slate-200 rounded-lg overflow-hidden text-center text-xs">
            <div class="grid grid-cols-12 bg-slate-50 font-bold text-slate-400 py-2 border-b border-slate-200">
              <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HASIL</div>
            </div>
            <div class="grid grid-cols-12 py-1 items-center border-b border-slate-100">
              <div class="col-span-2">‚òÄÔ∏è</div>
              <div class="col-span-4 px-1"><input type="number" id="mha-run-siang" class="table-input" placeholder="0" oninput="calcUnit('mha')"></div>
              <div class="col-span-4 px-1"><input type="number" id="mha-trip-siang" class="table-input" placeholder="0" oninput="calcUnit('mha')"></div>
              <div class="col-span-2 font-black" id="mha-res-siang">0</div>
            </div>
            <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
              <div class="col-span-2">üåô</div>
              <div class="col-span-4 px-1"><input type="number" id="mha-run-malam" class="table-input" placeholder="0" oninput="calcUnit('mha')"></div>
              <div class="col-span-4 px-1"><input type="number" id="mha-trip-malam" class="table-input" placeholder="0" oninput="calcUnit('mha')"></div>
              <div class="col-span-2 font-black" id="mha-res-malam">0</div>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div><span class="text-xs font-bold text-slate-700">KARUNIA</span></div>
          <div class="border border-slate-200 rounded-lg overflow-hidden text-center text-xs">
            <div class="grid grid-cols-12 bg-slate-50 font-bold text-slate-400 py-2 border-b border-slate-200">
              <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HASIL</div>
            </div>
            <div class="grid grid-cols-12 py-1 items-center border-b border-slate-100">
              <div class="col-span-2">‚òÄÔ∏è</div>
              <div class="col-span-4 px-1"><input type="number" id="kai-run-siang" class="table-input" placeholder="0" oninput="calcUnit('kai')"></div>
              <div class="col-span-4 px-1"><input type="number" id="kai-trip-siang" class="table-input" placeholder="0" oninput="calcUnit('kai')"></div>
              <div class="col-span-2 font-black" id="kai-res-siang">0</div>
            </div>
            <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
              <div class="col-span-2">üåô</div>
              <div class="col-span-4 px-1"><input type="number" id="kai-run-malam" class="table-input" placeholder="0" oninput="calcUnit('kai')"></div>
              <div class="col-span-4 px-1"><input type="number" id="kai-trip-malam" class="table-input" placeholder="0" oninput="calcUnit('kai')"></div>
              <div class="col-span-2 font-black" id="kai-res-malam">0</div>
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full bg-yellow-500"></div><span class="text-xs font-bold text-slate-700">BUMA</span></div>
          <div class="border border-slate-200 rounded-lg overflow-hidden text-center text-xs">
            <div class="grid grid-cols-12 bg-slate-50 font-bold text-slate-400 py-2 border-b border-slate-200">
              <div class="col-span-2">SHIFT</div><div class="col-span-4">UNIT</div><div class="col-span-4">TRIP</div><div class="col-span-2">HASIL</div>
            </div>
            <div class="grid grid-cols-12 py-1 items-center border-b border-slate-100">
              <div class="col-span-2">‚òÄÔ∏è</div>
              <div class="col-span-4 px-1"><input type="number" id="buma-run-siang" class="table-input" placeholder="0" oninput="calcUnit('buma')"></div>
              <div class="col-span-4 px-1"><input type="number" id="buma-trip-siang" class="table-input" placeholder="0" oninput="calcUnit('buma')"></div>
              <div class="col-span-2 font-black" id="buma-res-siang">0</div>
            </div>
            <div class="grid grid-cols-12 py-1 items-center bg-slate-50/50">
              <div class="col-span-2">üåô</div>
              <div class="col-span-4 px-1"><input type="number" id="buma-run-malam" class="table-input" placeholder="0" oninput="calcUnit('buma')"></div>
              <div class="col-span-4 px-1"><input type="number" id="buma-trip-malam" class="table-input" placeholder="0" oninput="calcUnit('buma')"></div>
              <div class="col-span-2 font-black" id="buma-res-malam">0</div>
            </div>
          </div>
        </div>

        <div class="bg-slate-100 p-3 rounded flex justify-between items-center text-sm">
          <span class="font-bold text-slate-500">Total Hauling</span>
          <span id="grand-total" class="font-black text-indigo-700 text-lg">0</span>
        </div>
      </div>
    </section>

    <!-- 3. UNIT SDT RUNNING -->
    <section class="card">
      <div class="card-head flex justify-between items-center">
        <div><div class="font-bold">3. Unit SDT Running</div></div>
        <button onclick="toggleConfig()" class="text-[10px] text-blue-600 underline font-bold">Config</button>
      </div>
      <div class="card-body">
        <div id="configPanel" class="hidden bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs mb-4">
          <div class="grid grid-cols-2 gap-2">
            <div class="flex gap-1"><input id="newUnit" placeholder="Unit Baru" class="input-base py-1"><button onclick="addMaster('unit')" class="bg-blue-600 text-white px-2 rounded">+</button></div>
            <div class="flex gap-1"><input id="newDriver" placeholder="Driver Baru" class="input-base py-1"><button onclick="addMaster('driver')" class="bg-emerald-600 text-white px-2 rounded">+</button></div>
          </div>
          <div id="adminSaveNote" class="mt-3 text-[12px] text-slate-700"></div>
        </div>

        <div class="mb-4"><div id="unitBtnContainer" class="flex flex-wrap gap-2"></div></div>
        <div id="sdtList" class="space-y-3"></div>
        <div id="emptyMsg" class="text-center py-6 text-slate-300 text-xs italic border border-dashed rounded mt-2">Belum ada data. Klik tombol unit di atas.</div>
      </div>
    </section>

    <!-- ACTIONS -->
    <div class="grid grid-cols-2 gap-3">
      <button onclick="copyReport(false)" class="bg-white border border-purple-200 text-purple-700 font-bold py-3 rounded-xl shadow-sm hover:bg-purple-50 text-xs">Salin SIANG</button>
      <button onclick="copyReport(true)" class="bg-white border border-indigo-200 text-indigo-700 font-bold py-3 rounded-xl shadow-sm hover:bg-indigo-50 text-xs">Salin MALAM</button>
    </div>

  </div>

  <!-- FAB add (masuk form harian) -->
  <button class="fab" onclick="window.scrollTo(0, document.body.scrollHeight);">+</button>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-3 rounded shadow-xl text-xs hidden transition-all duration-300 transform translate-y-10">Teks berhasil disalin!</div>

  <!-- FIREBASE compat (easy) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

<script>
/* ========= SETTINGS & STATE ========= */
const DEFAULT_SPV = ['Ihsan R','Dicky F','Sopian'];
const DEFAULT_FRM = ['Gunawan TC','Hardiansyah','Lewi S','Elimelek J','Andry K','Yulius R'];
const DEFAULT_CHK = ['Indra R','Jemmie P','Ikram','Fahri T','Indra A','Andhy S','Agus','Angga','Henderi A','L Fauzan N','Nanda P'];
const DEFAULT_UNITS = ["01-F","02-F","03-F","3A-F","05-F","08-P","09-P","10-P","25-P"];
const DEFAULT_DRIVERS = ["Jeksen","Saipul","Julio","Ardianur","Suryadi","Agung","Faturahman"];
const DEFAULT_PT = ['MHA','KARUNIA','BUMA'];
const DEFAULT_CONV = ['SD1','SD2','SD3'];

const ADMIN_USER = "admin", ADMIN_PASS = "mpadmin", ADMIN_TOKEN = "A9X2-FF39-MPA-2024-SECURE";

const firebaseConfig = {
  apiKey: "AIzaSyDGPkoewPcjffZ8ORwB3rrVAKiYtRYzuEk",
  authDomain: "retase-20ec2.firebaseapp.com",
  projectId: "retase-20ec2",
  storageBucket: "retase-20ec2.firebasestorage.app",
  messagingSenderId: "414104675676",
  appId: "1:414104675676:web:95f0012dadfb1743ff8d99",
  measurementId: "G-64RN0GNMPW"
};

let db = null;
let activeSD = 'SD1';
let conveyorData = { SD1:[], SD2:[], SD3:[] };
let sdtData = []; // array of objects {id, unit, driver, trip, ket}
let masterUnits = [...DEFAULT_UNITS];
let masterDrivers = [...DEFAULT_DRIVERS];
let SPV = [...DEFAULT_SPV], FRM = [...DEFAULT_FRM], CHK = [...DEFAULT_CHK];

/* ===== init and firebase wait ===== */
function waitForFirebaseAndStart() {
  let tries = 0;
  const id = setInterval(()=>{
    tries++;
    if(window.firebase && firebase.firestore) {
      clearInterval(id);
      try {
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        startApp(false);
      } catch(e) {
        console.error(e);
        startApp(true);
      }
    } else if(tries>60) {
      clearInterval(id);
      alert('Firebase SDK gagal dimuat. Buka di Chrome dan periksa koneksi.');
      startApp(true);
    }
  },200);
}

window.onload = ()=>{
  document.getElementById('inputTanggal').value = new Date().toISOString().split('T')[0];
  document.getElementById('btnScrollBottom').onclick = ()=>window.scrollTo(0,document.body.scrollHeight);
  document.getElementById('adminToggle').onclick = ()=>openAdmin();
  lucide.createIcons();
  waitForFirebaseAndStart();
};

/* ===== startApp ===== */
function startApp(fallback=false) {
  initChips('spvContainer', SPV); initChips('foremanContainer', FRM); initChips('checkerContainer', CHK);
  renderUnitButtons();
  addTimeRow('SD1'); addTimeRow('SD1'); addTimeRow('SD2'); addTimeRow('SD3');
  renderSdtList(); renderHistoryLocal(JSON.parse(localStorage.getItem('hist')||'[]'));
  if(db && !fallback) {
    subscribeSettings();
    subscribeSdt();
    subscribeHistory();
  }
}

/* ===== UI helper ===== */
function initChips(id, list) {
  document.getElementById(id).innerHTML = list.map(n => `<label class="chip-label inline-block mr-2 mb-1"><input type="checkbox" value="${n}" class="hidden"><div class="chip-div">${n}</div></label>`).join('');
}
function switchTab(sd) {
  activeSD = sd;
  ['SD1','SD2','SD3'].forEach(n=>{
    document.getElementById(`tab-${n}`).className = `tab-btn ${n===sd?'active':''}`;
    document.getElementById(`container-${n}`).className = `space-y-2 ${n===sd?'':'hidden'}`;
  });
}

/* ===== Time rows (same logic) ===== */
function addTimeRow(sd) {
  if(!conveyorData[sd]) conveyorData[sd]=[];
  const idx = conveyorData[sd].length;
  conveyorData[sd].push({ sh:'', sm:'', fh:'', fm:'' });
  const div = document.createElement('div');
  div.id = `row-${sd}-${idx}`;
  div.className = "grid grid-cols-12 gap-2 items-center bg-white p-2 rounded border border-slate-100 shadow-sm";
  div.innerHTML = `
    <div class="col-span-1 text-center font-bold text-slate-300 text-xs">${idx+1}</div>
    <div class="col-span-5 time-box"><input type="tel" maxlength="2" placeholder="HH" class="time-digit" oninput="updTime('${sd}',${idx},'sh',this)">:<input type="tel" maxlength="2" placeholder="MM" class="time-digit" oninput="updTime('${sd}',${idx},'sm',this)"></div>
    <div class="col-span-5 time-box"><input type="tel" maxlength="2" placeholder="HH" class="time-digit" oninput="updTime('${sd}',${idx},'fh',this)">:<input type="tel" maxlength="2" placeholder="MM" class="time-digit" oninput="updTime('${sd}',${idx},'fm',this)"></div>
    <div class="col-span-1 text-center"><button onclick="delTimeRow('${sd}',${idx})" class="text-slate-300 hover:text-red-500 font-bold">√ó</button></div>
  `;
  document.getElementById(`container-${sd}`).appendChild(div);
}
function updTime(sd, idx, f, el) {
  let v = el.value.replace(/\D/g,''); if(v.length>2) v=v.slice(0,2);
  if(v>23 && (f=='sh'||f=='fh')) v='23'; if(v>59 && (f=='sm'||f=='fm')) v='59';
  el.value=v; conveyorData[sd][idx][f]=v;
  calcConv(sd);
  if(v.length==2){ let n=el.nextElementSibling; if(n&&n.tagName=='INPUT') n.focus(); }
}
function delTimeRow(sd, idx) {
  const row = document.getElementById(`row-${sd}-${idx}`);
  if(row) row.style.display='none';
  conveyorData[sd][idx] = { sh:'', sm:'', fh:'', fm:'' };
  calcConv(sd);
}
function calcConv(sd) {
  let tot=0;
  (conveyorData[sd]||[]).forEach(d=>{
    if(d.sh!==''&&d.sm!==''&&d.fh!==''&&d.fm!=='') {
      let s=parseInt(d.sh)*60+parseInt(d.sm), f=parseInt(d.fh)*60+parseInt(d.fm);
      if(f<s) f+=1440; tot += (f-s);
    }
  });
  const th=Math.floor(tot/60), tm=tot%60;
  document.getElementById(`res-${sd}`).innerText = `${th}j ${tm}m`;
  let rem = (12*60)-tot; const rh=Math.floor(Math.abs(rem)/60), rm=Math.abs(rem)%60;
  const el = document.getElementById(`eff-${sd}`);
  if(tot===0){ el.innerText='-'; el.className="text-[10px] font-bold text-slate-300"; el.dataset.copy='-'; }
  else if(rem>=0){ el.innerText=`${rh}j ${rm}m`; el.className="text-[10px] font-bold text-emerald-600"; el.dataset.copy=`${rh} Jam ${String(rm).padStart(2,'0')} Menit`; }
  else { el.innerText=`${rh}j ${rm}m (Over)`; el.className="text-[10px] font-bold text-red-600"; el.dataset.copy=`${rh} Jam ${String(rm).padStart(2,'0')} Menit (Kelebihan Durasi)`; }
}

/* ===== Unit running calc (same) ===== */
function calcUnit(id) {
  const val = (s)=>parseFloat(document.getElementById(s).value)||0;
  const rs=val(`${id}-run-siang`), ts=val(`${id}-trip-siang`), rm=val(`${id}-run-malam`), tm=val(`${id}-trip-malam`);
  document.getElementById(`${id}-res-siang`).innerText = (ts-rs);
  document.getElementById(`${id}-res-malam`).innerText = ((tm-ts)-rm);
  let tot=0; ['mha','kai','buma'].forEach(k => tot += (val(`${k}-trip-malam`)-val(`${k}-trip-siang`)));
  document.getElementById('grand-total').innerText = tot + " Trip";
}

/* ===== Master management & unit buttons ===== */
function toggleConfig(){ document.getElementById('configPanel').classList.toggle('hidden'); }

function renderUnitButtons(){
  document.getElementById('unitBtnContainer').innerHTML = (masterUnits||[]).map(u =>
    `<button onclick="addSdt('${u}')" class="bg-white border border-slate-300 text-xs font-bold text-slate-600 px-3 py-1 rounded shadow-sm hover:bg-indigo-50 hover:text-indigo-600 transition active:scale-95">${u}</button>`
  ).join('');
}

/* ===== Add master (auto-save if admin) ===== */
function addMaster(t){
  const v = (t==='unit'? document.getElementById('newUnit').value.trim() : document.getElementById('newDriver').value.trim());
  if(!v) return alert('Isi dulu');
  if(t==='unit') masterUnits.push(v.toUpperCase()); else masterDrivers.push(v);
  renderUnitButtons();
  if(t === 'spv'){ SPV.push(v); initChips('spvContainer',SPV); }
  if(t === 'frm'){ FRM.push(v); initChips('foremanContainer',FRM); }
  if(t === 'chk'){ CHK.push(v); initChips('checkerContainer',CHK); }

  const token = sessionStorage.getItem('adminkey') || null;
  if(db && token === ADMIN_TOKEN){
    const payload = {
      supervisors: SPV, foremen: FRM, checkers: CHK,
      masterUnits: masterUnits, masterDrivers: masterDrivers,
      conv: DEFAULT_CONV, pt: DEFAULT_PT,
      _adminKey: token
    };
    db.doc('settings/lists').set(payload, { merge:true }).then(()=> {
      document.getElementById('adminSaveNote').innerText = 'Master tersimpan di Firestore.';
      console.log('master saved to firestore');
    }).catch(e => {
      console.error('save master err', e);
      alert('Gagal simpan master:'+ (e.message||e));
    });
  } else {
    console.log('master added locally (not admin)');
  }
  if(t==='unit') document.getElementById('newUnit').value=''; else document.getElementById('newDriver').value='';
}

/* ===== SDT: add, delete, update ===== */
function addSdt(u){
  // show placeholder immediate
  sdtData.unshift({ id:null, unit:u, driver:'', trip:0, ket:'', _local:true });
  renderSdtList();
  // persist to firestore
  if(db){
    db.collection('sdt').add({ unit:u, driver:'', trip:0, ket:'', createdAt: firebase.firestore.FieldValue.serverTimestamp() })
      .then(ref => console.log('sdt added',ref.id))
      .catch(e => { console.error('add sdt err',e); alert('Gagal simpan SDT'); });
  } else {
    console.log('offline: sdt saved local');
  }
  setTimeout(()=>document.getElementById('sdtList').lastElementChild?.scrollIntoView({behavior:'smooth',block:'center'}),100);
}
function delSdt(i){
  const id = sdtData[i] && sdtData[i].id;
  if(id && db) db.collection('sdt').doc(id).delete().catch(()=>{});
  sdtData.splice(i,1);
  renderSdtList();
}
function updSdt(i,f,v){
  sdtData[i][f]=v;
  const id = sdtData[i] && sdtData[i].id;
  if(id && db){
    const payload={}; payload[f]=v;
    db.collection('sdt').doc(id).set(payload,{merge:true}).catch(e=>console.error('upd sdt err',e));
  }
}

/* ===== render sdt list ===== */
function renderSdtList(){
  const c = document.getElementById('sdtList'), m = document.getElementById('emptyMsg');
  if(!c) return;
  if(sdtData.length===0){ c.innerHTML=''; m.style.display='block'; return; }
  m.style.display='none';
  const drvOpts = `<option value="">Driver...</option>` + masterDrivers.map(d=>`<option value="${d}">${d}</option>`).join('');
  c.innerHTML = sdtData.map((d,i)=>`
    <div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex flex-col gap-2 relative">
      <div class="flex justify-between items-center border-b border-slate-50 pb-1">
        <span class="font-bold text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">${d.unit}</span>
        <button onclick="delSdt(${i})" class="text-red-400 hover:text-red-600 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
      </div>
      <div class="grid grid-cols-12 gap-2 text-xs">
        <div class="col-span-5">
          <select onchange="updSdt(${i},'driver',this.value)" class="w-full border rounded p-1 bg-white outline-none">
            ${drvOpts.replace(`value="${d.driver}"`,`value="${d.driver}" selected`)}
          </select>
        </div>
        <div class="col-span-3 relative">
          <input type="number" placeholder="0" value="${d.trip||0}" oninput="updSdt(${i},'trip',this.value)" class="w-full border rounded p-1 text-center font-bold outline-none">
        </div>
        <div class="col-span-4">
          <input type="text" placeholder="Ket..." value="${d.ket||''}" oninput="updSdt(${i},'ket',this.value)" class="w-full border rounded p-1 text-red-500 italic outline-none">
        </div>
      </div>
    </div>
  `).join('');
  lucide.createIcons();
}

/* ===== COPY REPORT & save history ===== */
function getChecked(id){
  const arr = Array.from(document.querySelectorAll(`#${id} input:checked`)).map(e=>e.parentElement.innerText.trim());
  let mId='';
  if(id.includes('spv')) mId='inputSupervisorLainnya';
  if(id.includes('foreman')) mId='inputForemanLainnya';
  if(id.includes('checker')) mId='inputCheckerLainnya';
  const m = document.getElementById(mId).value.trim(); if(m) arr.push(m);
  return arr.join(', ');
}

function copyReport(isMalam){
  const shift = document.getElementById('inputShift').value;
  const date = document.getElementById('inputTanggal').value.split('-');
  const fmtDate = date.length===3 ? `${date[2]}/${["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGU","SEP","OKT","NOV","DES"][parseInt(date[1])-1]}/${date[0].slice(-2)}` : '-';

  let txt = `*CHP OPERATION*\n*${shift}*\n*${fmtDate}*\n\nSupervisor : ${getChecked('spvContainer')}\nForeman   : ${getChecked('foremanContainer')}\nChecker      : ${getChecked('checkerContainer')}\n\nEfektivitas Running\n`;
  ['SD1','SD2','SD3'].forEach(sd => txt += `- ${sd} = ${(document.getElementById(`eff-${sd}`).dataset.copy||'-')}\n`);
  txt += `\n`;

  const val = (id) => parseFloat(document.getElementById(id).value)||0;
  const calc = (b) => isMalam ? (val(`${b}-trip-malam`)-val(`${b}-trip-siang`)) : val(`${b}-trip-siang`);
  const mt=calc('mha'), kt=calc('kai'), bt=calc('buma'), tot=mt+kt+bt;
  const tip=val('inputTippingRom'), trans=val('inputTransferRom');

  txt += `Hauling\nMHA    : ${mt} TRIP\nBUMA   : ${bt} TRIP\nKAI    : ${kt} TRIP\nIP     : 0 TRIP\nTotal Hauling : ${tot} Trip\n\n`;
  txt += `TIPPING ROM        = ${tip} Trip\nTRANSFER ROM   = ${trans} Trip\nTRANSFER ROM + HAULING = ${trans+tot} Trip\n\n`;

  const suf = isMalam ? 'malam' : 'siang';
  txt += `Unit 2 Trip\n- MHA   = ${document.getElementById(`mha-res-${suf}`).innerText} Unit\n- BUMA  = ${document.getElementById(`buma-res-${suf}`).innerText} Unit\n- KAI   = ${document.getElementById(`kai-res-${suf}`).innerText} Unit\n\n`;

  txt += `Unit SDT Running:\n`;
  if(sdtData.length === 0) txt += `(List Kosong)`;
  else sdtData.forEach((d,i) => txt += `${i+1}.SDT ${d.unit} ${d.driver?`(${d.driver})`:''} : ${d.trip?d.trip+' Trip':''} ${d.ket?`*${d.ket}*`:''}\n`);

  // copy
  const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  const t = document.getElementById('toast'); t.classList.remove('hidden','translate-y-10'); setTimeout(()=>t.classList.add('translate-y-10'),2000); setTimeout(()=>t.classList.add('hidden'),2300);

  // save history to firestore or local and also update local history list immediately
  const historyObj = { action:'copy_report', shift, date: document.getElementById('inputTanggal').value, summary: txt, by:'public', ts: db ? firebase.firestore.FieldValue.serverTimestamp() : Date.now() };
  if(db){
    db.collection('history').add(historyObj)
      .then(()=> {
        const hlocal = JSON.parse(localStorage.getItem('hist')||'[]');
        const short = { shift: historyObj.shift, date: historyObj.date||new Date().toISOString(), summary: historyObj.summary, ts: Date.now() };
        hlocal.unshift(short);
        localStorage.setItem('hist', JSON.stringify(hlocal));
        renderHistoryLocal(hlocal);
      })
      .catch(e => {
        console.error('history save err', e);
        const hlocal = JSON.parse(localStorage.getItem('hist')||'[]');
        const short = { shift: historyObj.shift, date: historyObj.date||new Date().toISOString(), summary: historyObj.summary, ts: Date.now() };
        hlocal.unshift(short);
        localStorage.setItem('hist', JSON.stringify(hlocal));
        renderHistoryLocal(hlocal);
      });
  } else {
    const hlocal = JSON.parse(localStorage.getItem('hist')||'[]');
    const short = { shift: historyObj.shift, date: historyObj.date||new Date().toISOString(), summary: historyObj.summary, ts: Date.now() };
    hlocal.unshift(short);
    localStorage.setItem('hist', JSON.stringify(hlocal));
    renderHistoryLocal(hlocal);
  }
}

/* ====== FIRESTORE SUBSCRIBERS ====== */
function subscribeSettings(){
  if(!db) return;
  db.doc('settings/lists').onSnapshot(doc=>{
    if(!doc.exists) { renderMasterToUI(); return; }
    const d = doc.data()||{};
    SPV = d.supervisors || SPV;
    FRM = d.foremen || FRM;
    CHK = d.checkers || CHK;
    masterUnits = d.masterUnits || masterUnits;
    masterDrivers = d.masterDrivers || masterDrivers;
    renderMasterToUI();
  },e=>console.error('settings listen err',e));
}
function renderMasterToUI(){ initChips('spvContainer',SPV); initChips('foremanContainer',FRM); initChips('checkerContainer',CHK); renderUnitButtons(); }

function subscribeSdt(){
  if(!db) return;
  db.collection('sdt').orderBy('createdAt','desc').onSnapshot(snap=>{
    const arr = [];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
    sdtData = arr;
    renderSdtList();
  }, e=>console.error('sdt listen err',e));
}

function subscribeHistory(){
  if(!db) return;
  db.collection('history').orderBy('ts','desc').limit(20).onSnapshot(snap=>{
    const arr = [];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
    renderHistory(arr);
  }, e=>console.error('history listen err',e));
}

/* ===== render history ===== */
function renderHistory(items){
  const list = document.getElementById('historyList'), count = document.getElementById('historyCount');
  if(!list) return;
  if(!items || items.length===0){ list.innerHTML = '<div class="text-slate-400">Belum ada history.</div>'; count.innerText = '0'; return; }
  count.innerText = String(items.length);
  list.innerHTML = items.map(it=>{
    const dt = it.date || (it.ts ? (new Date(it.ts.seconds*1000).toLocaleString()) : '-');
    const title = (it.shift||'-');
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;border:1px solid #eef2ff;background:white">
      <div><div style="font-weight:700">${title}</div><div style="font-size:12px;color:#64748b">${dt}</div></div>
      <div style="font-size:12px;color:#4f46e5;cursor:pointer" onclick="viewHistory('${escapeHtml(it.summary||'')}', '${escapeHtml(title)}', '${escapeHtml(dt)}')">Lihat</div>
    </div>`;
  }).join('');
}
function renderHistoryLocal(h){
  const list = document.getElementById('historyList'), count = document.getElementById('historyCount');
  if(!list) return;
  if(!h || h.length===0){ list.innerHTML = '<div class="text-slate-400">Belum ada history.</div>'; count.innerText = '0'; return; }
  count.innerText = String(h.length);
  list.innerHTML = h.map(it=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;border:1px solid #eef2ff;background:white">
    <div><div style="font-weight:700">${it.shift||'-'}</div><div style="font-size:12px;color:#64748b">${it.date||'-'}</div></div>
    <div style="font-size:12px;color:#4f46e5;cursor:pointer" onclick="viewHistory('${escapeHtml(it.summary||'')}', '${escapeHtml(it.shift||'-')}', '${escapeHtml(it.date||'-')}')">Lihat</div>
  </div>`).join('');
}

/* view history modal (simple) */
function viewHistory(summary, title, dt){
  try {
    const win = window.open("", "_blank", "width=400,height=600");
    win.document.write(`<pre style="white-space:pre-wrap;font-family:Arial;padding:10px">${unescapeHtml(summary)}</pre>`);
    win.document.title = `History - ${unescapeHtml(title)} - ${unescapeHtml(dt)}`;
  } catch(e){
    alert('Tidak bisa buka jendela baru; summary:\n\n'+unescapeHtml(summary));
  }
}

/* safe helpers */
function escapeHtml(s){ return String(s||'').replaceAll("'", "\\'").replaceAll('"','&quot;').replaceAll('\n','\\n').replaceAll('\r',''); }
function unescapeHtml(s){ return String(s||'').replaceAll('\\n','\n').replaceAll('\\r',''); }

/* ===== ADMIN (prompt) & admin panel funcs ===== */
function openAdmin(){
  const logged = sessionStorage.getItem('adminkey') === ADMIN_TOKEN;
  if(logged){
    document.getElementById('adminPanel').classList.remove('hidden');
    renderAdminLists();
    return;
  }
  const user = prompt('Username:','admin');
  const pass = prompt('Password:','');
  if(user === ADMIN_USER && pass === ADMIN_PASS){
    sessionStorage.setItem('adminkey', ADMIN_TOKEN);
    alert('Login admin sukses.');
    document.getElementById('adminPanel').classList.remove('hidden');
    renderAdminLists();
  } else alert('Login gagal.');
}
function closeAdmin(){ document.getElementById('adminPanel').classList.add('hidden'); }

function addPerson(){
  const type = document.getElementById('adminType').value;
  const val = document.getElementById('adminValue').value.trim();
  if(!val) return alert('Masukkan nilai.');
  if(type === 'supervisor'){ SPV.push(val); initChips('spvContainer', SPV); }
  if(type === 'foreman'){ FRM.push(val); initChips('foremanContainer', FRM); }
  if(type === 'checker'){ CHK.push(val); initChips('checkerContainer', CHK); }
  if(type === 'unit'){ masterUnits.push(val.toUpperCase()); renderUnitButtons(); }
  if(type === 'driver'){ masterDrivers.push(val); renderUnitButtons(); renderSdtList(); }

  const token = sessionStorage.getItem('adminkey') || null;
  if(db && token === ADMIN_TOKEN){
    let field = null;
    if(type === 'supervisor') field = 'supervisors';
    if(type === 'foreman') field = 'foremen';
    if(type === 'checker') field = 'checkers';
    if(type === 'unit') field = 'masterUnits';
    if(type === 'driver') field = 'masterDrivers';
    if(field){
      const updateObj = {};
      updateObj[field] = firebase.firestore.FieldValue.arrayUnion(val);
      db.doc('settings/lists').set(updateObj, { merge: true })
        .then(()=> {
          document.getElementById('adminValue').value = '';
          document.getElementById('adminSaveNote').innerText = 'Tersimpan di server.';
          renderAdminLists();
        })
        .catch(e => { console.error('save master err', e); alert('Gagal simpan ke server.'); });
    }
  } else {
    const local = JSON.parse(localStorage.getItem('localMasters')||'{}');
    if(!local[type]) local[type]=[];
    local[type].push(val);
    localStorage.setItem('localMasters', JSON.stringify(local));
    document.getElementById('adminValue').value = '';
    document.getElementById('adminSaveNote').innerText = 'Tersimpan lokal (offline).';
    renderAdminLists();
  }
}

function renderAdminLists(){
  document.getElementById('listSpv').innerText = (SPV.length? SPV.join(', ') : '-');
  document.getElementById('listFrm').innerText = (FRM.length? FRM.join(', ') : '-');
  document.getElementById('listChk').innerText = (CHK.length? CHK.join(', ') : '-');
  document.getElementById('listUnit').innerText = (masterUnits.length? masterUnits.join(', ') : '-');
  document.getElementById('listDriver').innerText = (masterDrivers.length? masterDrivers.join(', ') : '-');
}

function reloadSettingsFromServer(){
  if(!db) return alert('Firebase tidak tersedia.');
  db.doc('settings/lists').get().then(doc=>{
    if(!doc.exists) return alert('Belum ada data di server.');
    const d = doc.data() || {};
    SPV = d.supervisors || SPV;
    FRM = d.foremen || FRM;
    CHK = d.checkers || CHK;
    masterUnits = d.masterUnits || masterUnits;
    masterDrivers = d.masterDrivers || masterDrivers;
    renderMasterToUI();
    renderAdminLists();
    alert('Data master disegarkan.');
  }).catch(e => { console.error(e); alert('Gagal memuat dari server'); });
}

/* ===== START FIREBASE WAIT ===== */
waitForFirebaseAndStart();

</script>
</body>
</html>